<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GolpoShare - আপনার গল্প শেয়ার করুন</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', sans-serif;
        }

        :root {
            --primary: #1e88e5;
            --primary-dark: #1565c0;
            --primary-light: #64b5f6;
            --accent: #ff4081;
            --text: #212121;
            --text-light: #757575;
            --background: #f5f5f5;
            --surface: #ffffff;
            --error: #f44336;
            --success: #4caf50;
            --chat-sent: #e3f2fd;
            --chat-received: #f5f5f5;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* GLOBAL LOADER */
        #global-loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--surface);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Verified Badge */
        .verified-badge {
            color: #1e88e5;
            font-size: 14px;
            margin-left: 4px;
            vertical-align: middle;
            display: inline-block;
        }
        
        /* Role Badges (New Feature 1) */
        .role-badge {
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 10px;
            margin-left: 5px;
            vertical-align: middle;
            font-weight: 500;
            display: inline-block;
            text-transform: uppercase;
        }
        .role-admin { background-color: #d32f2f; }     /* Red */
        .role-moderator { background-color: #2e7d32; } /* Green */
        .role-adviser { background-color: #fbc02d; color: #000; } /* Yellow */
        .role-editor { background-color: #1565c0; }    /* Blue */

        /* Pending Badge */
        .pending-badge {
            background-color: #FFA500;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 4000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: #323232;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            text-align: center;
            min-width: 250px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Auth Pages */
        .auth-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
        }

        .auth-card {
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            padding: 30px;
            margin: 20px 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 28px;
            font-weight: 700;
        }

        .logo p {
            color: var(--text-light);
            font-size: 14px;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }

        .btn {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }
        
        .btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        .btn-loading .btn-text {
            display: none;
        }
        .btn-loading .btn-spinner {
            display: block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        .btn-spinner { display: none; }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(30, 136, 229, 0.1);
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            color: white;
        }

        .auth-footer a {
            color: white;
            text-decoration: underline;
        }

        /* Header & Nav Icons */
        .header {
            background-color: var(--surface);
            color: var(--text);
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            cursor: pointer;
        }

        .nav-icons {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text);
            cursor: pointer;
            position: relative;
            padding: 5px;
        }
        
        .nav-icon-btn:hover {
            color: var(--primary);
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--error);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            display: none;
        }

        .notification-badge.show {
            display: block;
        }

        .profile-menu {
            position: relative;
        }

        .profile-pic {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid #eee;
        }

        .dropdown-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: var(--surface);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            width: 220px;
            display: none;
            z-index: 1001;
            overflow: hidden;
        }
        
        #notification-dropdown {
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
        }
        .notification-item:hover { background-color: #f9f9f9; }
        .notification-item.unread { background-color: #e3f2fd; }
        .notif-pic { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }


        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text);
            text-decoration: none;
            border-bottom: 1px solid #eee;
            transition: all 0.2s;
            cursor: pointer;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .dropdown-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Newsfeed */
        .newsfeed {
            padding: 20px 0;
            padding-bottom: 80px;
        }

        /* CREATE POST TRIGGER */
        .create-post-trigger-box {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .trigger-user-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        .trigger-input-fake {
            background-color: #f0f2f5;
            border-radius: 20px;
            padding: 10px 20px;
            flex-grow: 1;
            color: #65676b;
            font-size: 15px;
        }
        .trigger-input-fake:hover {
            background-color: #e4e6e9;
        }

        /* POST STYLES */
        .post {
            background-color: var(--surface);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            position: relative;
        }

        .post-header {
            display: flex;
            align-items: center;
            padding: 15px;
            position: relative;
        }

        .post-user-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            cursor: pointer;
        }

        .post-user-info h3 {
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .post-user-info h3:hover { text-decoration: underline; }

        .post-user-info p {
            font-size: 12px;
            color: var(--text-light);
        }

        /* 3-DOT MENU */
        .post-menu-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            font-size: 16px;
            color: var(--text-light);
            cursor: pointer;
            padding: 5px;
        }
        .post-menu-dropdown {
            position: absolute;
            top: 40px;
            right: 10px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border-radius: 8px;
            width: 150px;
            display: none;
            z-index: 5;
            overflow: hidden;
        }
        .post-menu-dropdown.show { display: block; }
        .post-menu-item {
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: var(--text);
        }
        .post-menu-item:hover { background: #f5f5f5; }
        .post-menu-item i { margin-right: 8px; width: 15px; text-align: center; }

        .post-content {
            padding: 0 15px 15px;
        }
        .post-content p {
            white-space: pre-wrap;
        }

        /* Rich Text & Embeds */
        a.detected-link {
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
        }
        .youtube-embed {
            width: 100%;
            aspect-ratio: 16 / 9;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
        }
        .user-mention {
            color: var(--primary-dark);
            font-weight: 600;
            cursor: pointer;
            background: rgba(30, 136, 229, 0.1);
            padding: 0 4px;
            border-radius: 4px;
        }

        .post-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 500px;
            object-fit: contain;
            background: #000;
        }

        .post-engagement {
            display: flex;
            justify-content: space-around;
            padding: 10px 15px;
            border-top: 1px solid #eee;
        }

        .engagement-btn {
            display: flex;
            align-items: center;
            color: var(--text-light);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            flex-grow: 1;
            justify-content: center;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .engagement-btn:hover {
            background-color: #f0f0f0;
        }
        .engagement-btn i {
            margin-right: 5px;
        }
        .engagement-btn .fa-heart.liked {
            color: var(--accent);
            font-weight: 900;
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        
        /* Comments Section */
        .comment-section {
            padding: 0 15px 15px;
            border-top: 1px solid #eee;
            display: none;
        }
        .add-comment-form {
            display: flex;
            margin-top: 10px;
            align-items: center;
        }
        .comment-input {
            flex-grow: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 8px 12px;
            margin-right: 10px;
        }
        .comment-submit-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 16px;
        }
        .comments-list {
            margin-top: 15px;
        }
        .comment {
            display: flex;
            margin-bottom: 10px;
            position: relative;
        }
        .comment.reply-indent {
            margin-left: 40px;
            border-left: 2px solid #eee;
            padding-left: 5px;
        }
        .comment-user-pic {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .comment-body {
            background-color: #f0f2f5;
            border-radius: 15px;
            padding: 8px 12px;
            font-size: 14px;
            flex-grow: 1;
        }
        .comment-body strong {
            display: inline-flex;
            align-items: center;
            font-weight: 600;
        }
        .comment-actions {
            display: flex;
            gap: 10px;
            font-size: 12px;
            margin-top: 4px;
            margin-left: 5px;
        }
        .comment-action-btn {
            border: none;
            background: none;
            color: #777;
            cursor: pointer;
            font-size: 11px;
        }
        .comment-action-btn:hover { color: var(--primary); }
        .replying-to-alert {
            font-size: 12px;
            color: var(--primary);
            margin-bottom: 5px;
            display: none;
            align-items: center;
        }

        /* Profile Page */
        .profile-header {
            background-color: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .cover-photo {
            height: 200px;
            background-color: var(--primary-light);
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: default;
        }
        .cover-photo.editable {
            cursor: pointer;
        }
        .cover-photo.editable:hover::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.1);
        }

        .profile-info {
            padding: 0 20px 20px;
            position: relative;
            margin-top: -60px;
            text-align: center;
        }

        .profile-pic-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--surface);
            cursor: default;
            display: inline-block;
            background: #eee;
        }
        
        .profile-pic-large.editable {
            cursor: pointer;
        }

        .profile-details {
            margin-top: 10px;
        }
        
        .profile-details h2 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .profile-details p {
            color: var(--text-light);
            margin-bottom: 15px;
            display: inline-block;
        }
        
        .edit-bio-btn {
            font-size: 12px;
            color: var(--primary);
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
            display: none; /* Hidden by default */
        }

        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
        }
        .stat {
            text-align: center;
        }
        .stat-count {
            font-weight: 600;
            font-size: 16px;
            display: block;
        }
        .stat-label {
            color: var(--text-light);
            font-size: 12px;
        }

        /* Search Overlay */
        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--surface);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .search-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .search-input {
            flex-grow: 1;
            border: none;
            font-size: 18px;
            padding: 10px;
            outline: none;
        }
        .search-results {
            flex-grow: 1;
            overflow-y: auto;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
        }
        .search-result-item:hover { background: #f9f9f9; }
        .search-user-pic { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }

        /* Inbox & Chat */
        .inbox-list {
            background: var(--surface);
            min-height: 100vh;
        }
        .inbox-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .inbox-item:hover { background-color: #f9f9f9; }
        
        /* Chat Interface */
        .chat-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--surface);
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-user-details { display: flex; align-items: center; }
        .chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background: #e5ddd5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message-bubble {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 15px;
            position: relative;
            word-wrap: break-word;
        }
        .message-bubble.sent {
            align-self: flex-end;
            background-color: var(--chat-sent);
            border-top-right-radius: 0;
        }
        .message-bubble.received {
            align-self: flex-start;
            background-color: var(--surface);
            border-top-left-radius: 0;
        }
        .message-img { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .message-time { font-size: 10px; color: #777; text-align: right; margin-top: 2px; display: block;}
        .message-status { font-size: 10px; color: #999; font-style: italic; margin-right: 5px;}
        
        .chat-footer-area {
            background: var(--surface);
            border-top: 1px solid #ddd;
        }
        .chat-image-preview {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: none;
            position: relative;
            background: #f9f9f9;
        }
        .chat-image-preview img {
            max-height: 100px;
            border-radius: 8px;
        }
        .remove-preview-btn {
            position: absolute;
            top: 5px;
            left: 100px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .chat-input-area {
            padding: 10px;
            display: flex;
            align-items: center;
        }
        
        /* Message Context Menu */
        .msg-options-btn {
            position: absolute;
            top: 2px;
            right: 5px;
            background: none;
            border: none;
            font-size: 10px;
            color: #999;
            cursor: pointer;
            display: none; /* Hidden until hover */
        }
        .message-bubble:hover .msg-options-btn {
            display: block;
        }
        .msg-context-menu {
            position: absolute;
            top: 20px;
            right: 10px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 10;
            display: none;
            overflow: hidden;
            min-width: 80px;
        }
        .msg-context-menu button {
            display: block;
            width: 100%;
            padding: 5px 10px;
            border: none;
            background: none;
            text-align: left;
            font-size: 12px;
            cursor: pointer;
        }
        .msg-context-menu button:hover { background: #eee; }

        /* Settings Page */
        .settings-container {
            padding: 20px 0;
        }
        .settings-card {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .settings-card h3 {
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* LEADERBOARD STYLES */
        .leaderboard-header {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 0 0 20px 20px;
            margin-bottom: 20px;
        }
        .leaderboard-list {
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 80px; /* Space for sticky footer */
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .rank-num {
            width: 30px;
            font-weight: 700;
            color: var(--text-light);
            text-align: center;
        }
        .rank-1 { color: var(--gold); font-size: 20px; }
        .rank-2 { color: var(--silver); font-size: 18px; }
        .rank-3 { color: var(--bronze); font-size: 18px; }
        
        .lb-user-info {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }
        .lb-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            object-fit: cover;
        }
        .lb-score {
            font-weight: 700;
            color: var(--primary);
        }
        .my-rank-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        .lb-stats-mini {
            font-size: 10px;
            color: #888;
            margin-left: 10px;
        }

        /* Wallet Styles */
        .wallet-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(21, 101, 192, 0.3);
        }
        .balance-amount {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }

        /* Add Money & Subscription */
        .payment-method-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #eee;
        }
        .wmt-id-box {
            background: #fff;
            border: 1px dashed var(--primary);
            padding: 10px;
            text-align: center;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
            color: var(--primary-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .status-pending { color: #ff9800; font-weight: bold; font-size: 12px;}
        .status-approved { color: #4caf50; font-weight: bold; font-size: 12px;}
        .status-rejected { color: #f44336; font-weight: bold; font-size: 12px;}
        
        /* Withdraw Styles */
        .fee-info {
            font-size: 12px;
            color: var(--error);
            margin-top: 5px;
        }
        .net-amount-display {
            font-weight: bold;
            color: var(--success);
            margin-top: 10px;
            font-size: 14px;
        }

        /* MODALS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            transform: translateY(20px);
            transition: all 0.3s;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Utility Classes */
        .d-none {
            display: none !important;
        }
        .mt-3 {
            margin-top: 15px;
        }
        .upload-spinner {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary);
            font-size: 30px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            padding: 10px;
            display: none;
            z-index: 5;
        }
        
        /* --- NEW POST MODAL --- */
        .create-post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .create-post-input-area {
            width: 100%;
            border: none;
            outline: none;
            font-size: 18px;
            min-height: 100px;
            resize: none;
            margin-bottom: 10px;
        }
        .image-preview-area {
            width: 100%;
            max-height: 200px;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none;
        }
        .image-preview-area img {
            width: 100%;
            object-fit: cover;
        }
        .modal-post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .add-photo-btn {
            color: var(--success);
            cursor: pointer;
            font-size: 20px;
        }

     /* MAINTENANCE OVERLAY */
        #maintenance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: 99999; /* সবার উপরে থাকার জন্য */
            display: flex;
            flex-direction: column;
            justify_content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            display: none; /* ডিফল্টভাবে লুকানো থাকবে */
        }
        
        #maintenance-overlay.active {
            display: flex; /* ক্লাস active হলে দেখাবে */
        }

        .maintenance-icon {
            font-size: 60px;
            color: var(--warning, #ff9800);
            margin-bottom: 20px;
        }

        .maintenance-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--text);
            margin-bottom: 10px;
        }

        .maintenance-msg {
            color: var(--text-light);
            font-size: 16px;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <!-- Maintenance Screen -->
    <div id="maintenance-overlay">
        <i class="fas fa-tools maintenance-icon"></i>
        <div class="maintenance-title">মেইনটেন্যান্স চলছে</div>
        <p class="maintenance-msg" id="maintenance-message-text">আমাদের অ্যাপের উন্নয়নের কাজ চলছে। দয়া করে কিছুক্ষণ পর আবার চেষ্টা করুন।</p>
        <p style="margin-top:20px; font-weight:bold; color:#1e88e5;" id="maintenance-time-display"></p>
    </div>
    <!-- GLOBAL LOADER to Prevent Flicker -->
    <div id="global-loader">
        <div class="loader-spinner"></div>
        <div style="color: var(--primary); font-weight: bold;">GolpoShare</div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Sign Up Page -->
    <div id="signup-page" class="auth-container d-none">
        <div class="auth-card">
            <div class="logo">
                <h1>GolpoShare</h1>
                <p>আপনার গল্প শেয়ার করুন</p>
            </div>
            <form id="signup-form">
                <div class="form-group">
                    <label for="fullname">পুরো নাম</label>
                    <input type="text" id="fullname" class="form-control" placeholder="আপনার পুরো নাম লিখুন" required>
                </div>
                <div class="form-group">
                    <label for="dob">জন্ম তারিখ</label>
                    <input type="date" id="dob" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="gender">লিঙ্গ</label>
                    <select id="gender" class="form-control" required>
                        <option value="">লিঙ্গ নির্বাচন করুন</option>
                        <option value="male">পুরুষ</option>
                        <option value="female">মহিলা</option>
                        <option value="other">অন্যান্য</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="email">ইমেইল</label>
                    <input type="email" id="email" class="form-control" placeholder="আপনার ইমেইল লিখুন" required>
                </div>
                <div class="form-group">
                    <label for="password">পাসওয়ার্ড</label>
                    <input type="password" id="password" class="form-control" placeholder="পাসওয়ার্ড লিখুন" required>
                </div>
                <div class="form-group">
                    <label for="profile-pic-signup">প্রোফাইল ছবি</label>
                    <input type="file" id="profile-pic-signup" class="form-control" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="cover-photo-signup">কভার ফটো</label>
                    <input type="file" id="cover-photo-signup" class="form-control" accept="image/*">
                </div>
                <button type="submit" class="btn" id="signup-btn">
                    <span class="btn-text">সাইন আপ</span>
                    <span class="btn-spinner"></span>
                </button>
            </form>
            <p class="text-center mt-3">ইতিমধ্যে অ্যাকাউন্ট আছে? <a href="#" id="go-to-login">লগইন করুন</a></p>
        </div>
    </div>

    <!-- Login Page (Default) -->
    <div id="login-page" class="auth-container d-none">
        <div class="auth-card">
            <div class="logo">
                <h1>GolpoShare</h1>
                <p>আপনার গল্প শেয়ার করুন</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">ইমেইল</label>
                    <input type="email" id="login-email" class="form-control" placeholder="আপনার ইমেইল লিখুন" required>
                </div>
                <div class="form-group">
                    <label for="login-password">পাসওয়ার্ড</label>
                    <input type="password" id="login-password" class="form-control" placeholder="পাসওয়ার্ড লিখুন" required>
                </div>
                <button type="submit" class="btn" id="login-btn">
                    <span class="btn-text">লগইন</span>
                    <span class="btn-spinner"></span>
                </button>
            </form>
            <p class="text-center mt-3">অ্যাকাউন্ট নেই? <a href="#" id="go-to-signup">সাইন আপ করুন</a></p>
        </div>
    </div>

    <!-- Header -->
    <div id="app-header" class="header d-none">
        <div class="container">
            <div class="header-content">
                <h1 id="header-logo-btn">GolpoShare</h1>
                <div class="nav-icons">
                    <button class="nav-icon-btn" id="search-btn"><i class="fas fa-search"></i></button>
                    <button class="nav-icon-btn" id="inbox-btn"><i class="fas fa-envelope"></i></button>
                    <button class="nav-icon-btn" id="notif-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notif-badge">0</span>
                    </button>
                    <div class="dropdown-menu" id="notification-dropdown">
                        <div style="padding:10px; text-align:center; color:#777;">কোনো নতুন নোটিফিকেশন নেই</div>
                    </div>
                    <div class="profile-menu">
                        <img src="" alt="Profile" class="profile-pic" id="header-profile-pic">
                        <div class="dropdown-menu" id="profile-dropdown">
                            <a href="#" class="dropdown-item" id="nav-profile"><i class="fas fa-user"></i> আমার প্রোফাইল</a>
                            <a href="#" class="dropdown-item" id="nav-settings"><i class="fas fa-cog"></i> সেটিংস</a>
                            <a href="#" class="dropdown-item" id="nav-logout"><i class="fas fa-sign-out-alt"></i> লগআউট</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Home Page -->
    <div id="home-page" class="d-none app-view">
        <div class="container">
            <div class="newsfeed" id="newsfeed-container">
                <!-- New Create Post Trigger -->
                <div class="create-post-trigger-box" id="create-post-trigger">
                    <img src="" class="trigger-user-pic" id="trigger-user-pic">
                    <div class="trigger-input-fake">আপনার মনে কি আছে?</div>
                </div>
                
                <!-- Posts loaded here -->
            </div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profile-page" class="d-none app-view">
        <div class="container">
            <div class="profile-header">
                <div class="cover-photo" id="profile-cover-photo">
                    <input type="file" id="cover-photo-input" accept="image/*" style="display: none;">
                    <i class="fas fa-spinner fa-spin upload-spinner" id="cover-spinner"></i>
                </div>
                <div class="profile-info">
                    <div style="position: relative; display: inline-block;">
                        <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
                        <img src="" alt="Profile" class="profile-pic-large" id="profile-pic-large">
                         <i class="fas fa-spinner fa-spin upload-spinner" id="pic-spinner"></i>
                    </div>
                    <div class="profile-details">
                        <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                            <h2 id="profile-name">ব্যবহারকারীর নাম</h2>
                        </div>
                        <div>
                            <p id="profile-bio">বায়ো</p>
                            <button class="edit-bio-btn" id="edit-bio-trigger"><i class="fas fa-pen"></i></button>
                        </div>
                        
                        <div id="profile-actions" style="margin-bottom: 10px;">
                             <button class="btn" id="follow-btn" style="width: auto; padding: 5px 15px; font-size: 14px; display:none;">Follow</button>
                             <button class="btn" id="msg-btn" style="width: auto; padding: 5px 15px; font-size: 14px; margin-left:5px; display:none;"><i class="fas fa-comment"></i> Message</button>
                        </div>

                        <div class="profile-stats">
                            <div class="stat">
                                <span class="stat-count" id="following-count">0</span>
                                <span class="stat-label">Following</span>
                            </div>
                            <div class="stat">
                                <span class="stat-count" id="follower-count">0</span>
                                <span class="stat-label">Followers</span>
                            </div>
                            <div class="stat">
                                <span class="stat-count" id="like-count">0</span>
                                <span class="stat-label">Total Likes</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="newsfeed" id="user-posts-container">
                <!-- User posts -->
            </div>
        </div>
    </div>
    
    <!-- Inbox Page -->
    <div id="inbox-page" class="d-none app-view">
        <div class="container">
            <h2 style="padding: 15px 0; font-size: 20px;">ইনবক্স</h2>
            <div class="inbox-list" id="inbox-list">
                <div style="text-align:center; padding:20px; color:#777;">লোড হচ্ছে...</div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chat-page" class="chat-interface d-none">
        <div class="chat-header">
            <div class="chat-user-details">
                <button id="back-from-chat" style="background:none; border:none; color:white; font-size:18px; margin-right:10px; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                <img src="" id="chat-header-pic" style="width:35px; height:35px; border-radius:50%; margin-right:10px;">
                <span id="chat-header-name" style="font-weight:600;">Name</span>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Messages -->
        </div>
        <div class="chat-footer-area">
            <div class="chat-image-preview" id="chat-img-preview-container">
                <img src="" id="chat-img-preview-elem">
                <button class="remove-preview-btn" id="remove-preview-btn">x</button>
            </div>
            <form id="chat-form" class="chat-input-area">
                <input type="file" id="chat-img-input" accept="image/*" style="display:none;">
                <button type="button" id="chat-img-btn" style="background:none; border:none; font-size:20px; color:var(--primary); margin-right:10px; cursor:pointer;"><i class="fas fa-image"></i></button>
                <input type="text" id="chat-input" class="form-control" placeholder="মেসেজ লিখুন..." style="border-radius:20px;" autocomplete="off">
                <button type="submit" style="background:none; border:none; font-size:20px; color:var(--primary); margin-left:10px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

    <!-- Search Overlay -->
    <div id="search-page" class="search-overlay d-none">
        <div class="search-header">
            <button id="close-search" style="background:none; border:none; font-size:20px; margin-right:10px; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
            <input type="text" id="global-search-input" class="search-input" placeholder="সার্চ করুন (নাম অথবা পোস্ট ID)...">
        </div>
        <div class="search-results" id="search-results">
            <div style="text-align:center; color:#999; margin-top:20px;">ব্যবহারকারী বা পোস্ট খুঁজতে লিখুন</div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="d-none app-view">
        <div class="container settings-container">
            <h2 style="margin-bottom:20px;">সেটিংস</h2>
            <div class="settings-card">
                <h3>সাধারণ তথ্য</h3>
                <div class="dropdown-item" id="open-name-modal" style="cursor: pointer;">
                    <i class="fas fa-user-edit"></i> নাম পরিবর্তন করুন
                </div>
                <a href="#" id="go-to-hidden" class="dropdown-item" style="padding-left: 0; color: var(--text);">
                    <i class="fas fa-eye-slash"></i> Hidden Posts (হাইড পোস্ট)
                </a>
            </div>
            <div class="settings-card">
                <h3>অ্যাক্টিভিটি ও রিওয়ার্ড</h3>
                <a href="#" id="go-to-leaderboard" class="dropdown-item" style="padding-left: 0; color: var(--text);">
                    <i class="fas fa-trophy" style="color: gold;"></i> Leaderboard & Activities
                </a>
            </div>
            <div class="settings-card">
                <h3>নিরাপত্তা</h3>
                <div class="dropdown-item" id="open-password-modal" style="cursor: pointer;">
                     <i class="fas fa-lock"></i> পাসওয়ার্ড পরিবর্তন করুন
                </div>
            </div>
            <div class="settings-card">
                <h3>অর্থায়ন</h3>
                <a href="#" id="go-to-wallet" class="dropdown-item" style="border-bottom: 1px solid #eee; padding-left: 0; color: var(--text);"><i class="fas fa-wallet"></i> ওয়ালেট</a>
                <a href="#" id="go-to-subscription" class="dropdown-item" style="border-bottom: 1px solid #eee; padding-left: 0; color: var(--text);"><i class="fas fa-credit-card"></i> পেমেন্ট ও সাবস্ক্রিপশন (Add Money)</a>
                <a href="#" id="go-to-withdraw" class="dropdown-item" style="padding-left: 0; color: var(--text);"><i class="fas fa-money-bill-wave"></i> টাকা উত্তোলন (Withdraw)</a>
            </div>
        </div>
    </div>
    
    <!-- Hidden Posts Page -->
    <div id="hidden-posts-page" class="d-none app-view">
        <div class="container" style="padding-top: 20px;">
            <div style="display:flex; align-items:center; margin-bottom:20px;">
                <button onclick="history.back()" style="background:none; border:none; font-size:20px; margin-right:15px; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                <h2>হাইড করা পোস্টগুলো</h2>
            </div>
            <div id="hidden-posts-list">
                <!-- List will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Withdraw Page -->
    <div id="withdraw-page" class="d-none app-view">
        <div class="container" style="padding-top: 20px;">
            <div style="display:flex; align-items:center; margin-bottom:20px;">
                <button onclick="history.back()" style="background:none; border:none; font-size:20px; margin-right:15px; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                <h2>টাকা উত্তোলন</h2>
            </div>
            
            <div class="wallet-card">
                <p>উত্তোলনযোগ্য ব্যালেন্স</p>
                <div class="balance-amount" id="withdraw-balance">$0.00</div>
            </div>

            <div class="settings-card">
                <h3>উত্তোলনের বিবরণ</h3>
                <form id="withdraw-form">
                    <div class="form-group">
                        <label>পেমেন্ট মেথড</label>
                        <select id="withdraw-method" class="form-control" required>
                            <option value="">সিলেক্ট করুন</option>
                            <option value="wmt">WMT Wallet (0% Fee)</option>
                            <option value="bkash">bKash</option>
                            <option value="nagad">Nagad</option>
                            <option value="rocket">Rocket</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>অ্যাকাউন্ট নম্বর / WMT ID</label>
                        <input type="text" id="withdraw-account" class="form-control" placeholder="নাম্বার বা আইডি লিখুন" required>
                    </div>
                    <div class="form-group">
                        <label>টাকার পরিমাণ ($)</label>
                        <input type="number" step="0.01" id="withdraw-amount" class="form-control" placeholder="কত টাকা তুলতে চান?" required>
                        <div class="fee-info" id="withdraw-fee-info"></div>
                        <div class="net-amount-display" id="withdraw-net-display"></div>
                    </div>
                    <button type="submit" class="btn" id="withdraw-btn">
                        <span class="btn-text">সাবমিট রিকুয়েষ্ট</span>
                        <span class="btn-spinner"></span>
                    </button>
                </form>
            </div>
            
             <div class="settings-card">
                <h3>উত্তোলন ইতিহাস</h3>
                <div id="withdraw-history-list">
                    <p style="color:#777; text-align:center;">কোনো ইতিহাস নেই</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Page -->
    <div id="leaderboard-page" class="d-none app-view">
        <div class="container" style="padding: 0;">
            <div class="leaderboard-header">
                <button id="back-from-leaderboard" style="float: left; background:none; border:none; color:white; font-size:18px; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                <h2>লিডারবোর্ড (সাপ্তাহিক)</h2>
                <p style="font-size:12px; opacity:0.8;" id="lb-reward-info">সেরা ৩ জন প্রতি সপ্তাহে পাবে আকর্ষণীয় রিওয়ার্ড!</p>
            </div>
            <div class="container">
                <div id="leaderboard-list" class="leaderboard-list">
                    <div style="text-align:center; padding:20px;">লোড হচ্ছে...</div>
                </div>
            </div>
            <div class="my-rank-footer" id="my-rank-footer">
                <div style="display:flex; align-items:center;">
                    <span style="font-weight:bold;">আমার অবস্থান:</span>
                    <span id="my-rank-display" style="margin-left:10px; color:var(--primary); font-weight:700;">#--</span>
                </div>
                <div id="my-score-display">স্কোর: 0</div>
            </div>
        </div>
    </div>

    <!-- Wallet Page -->
    <div id="wallet-page" class="d-none app-view">
        <div class="container" style="padding: 20px 0;">
            <h2 style="margin-bottom:20px;">আমার ওয়ালেট</h2>
            <div class="wallet-card">
                <p>বর্তমান ব্যালেন্স</p>
                <div class="balance-amount" id="wallet-balance">$0.00</div>
                <p style="font-size:12px; opacity:0.8;">রিওয়ার্ড ও ডিপোজিট থেকে</p>
            </div>
            <div class="settings-card">
                <h3>লেনদেনের ইতিহাস</h3>
                <div id="transaction-list">
                    <p style="color:#777; text-align:center;">লোড হচ্ছে...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Money / Subscription Page -->
    <div id="subscription-page" class="d-none app-view">
        <div class="container" style="padding: 20px 0;">
            <h2 style="margin-bottom:20px;">পেমেন্ট ও সাবস্ক্রিপশন</h2>
            <div class="settings-card">
                <h3>Add Money</h3>
                <p style="font-size:14px; color:#666; margin-bottom:10px;">আপনার ওয়ালেটে টাকা যোগ করতে নিচের মার্চেন্ট আইডিতে PWMT পেমেন্ট করুন।</p>
                
                <div class="wmt-id-box">
                    <span id="wmt-id-text">PWMT4502</span>
                    <button class="copy-btn" onclick="copyWmtId()">Copy</button>
                </div>
                
                <div class="payment-method-box">
                    <form id="add-money-form">
                        <div class="form-group">
                            <label>টাকার পরিমাণ ($)</label>
                            <input type="number" step="0.01" id="deposit-amount" class="form-control" placeholder="যেমন: 10.00" required>
                        </div>
                        <div class="form-group">
                            <label>Transaction ID</label>
                            <input type="text" id="deposit-trx-id" class="form-control" placeholder="লেনদেনের ট্রানজেকশন আইডি" required>
                        </div>
                        <button type="submit" class="btn" id="deposit-btn">
                             <span class="btn-text">কনফার্ম করুন</span>
                             <span class="btn-spinner"></span>
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="settings-card">
                <h3>ডিপোজিট ইতিহাস</h3>
                <div id="deposit-history-list">
                    <p style="color:#777; text-align:center; padding:10px;">লোড হচ্ছে...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- CREATE POST MODAL -->
    <div id="create-post-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="create-post-header">
                 <h3 class="modal-title" style="margin:0; flex-grow:1; text-align:center;">পোস্ট তৈরি করুন</h3>
                 <button style="background:none; border:none; font-size:20px; cursor:pointer;" onclick="closeModal('create-post-modal')"><i class="fas fa-times"></i></button>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin-bottom:15px;">
            
            <div style="display:flex; align-items:center; margin-bottom:15px;">
                <img src="" id="modal-user-pic" style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
                <span style="font-weight:600;" id="modal-user-name">User Name</span>
            </div>
            
            <textarea id="modal-post-input" class="create-post-input-area" placeholder="আপনার মনে কি আছে?"></textarea>
            
            <div id="modal-image-preview" class="image-preview-area">
                <img src="" id="preview-img-elem">
            </div>
            
            <div class="modal-post-actions">
                <input type="file" id="modal-file-input" accept="image/*" style="display:none;">
                <div style="font-size:14px; font-weight:500;">আপনার পোস্টে যোগ করুন</div>
                <div style="display:flex; gap:15px;">
                    <i class="fas fa-image add-photo-btn" id="modal-add-photo" title="Photo"></i>
                </div>
            </div>
            
            <button class="btn" id="modal-submit-post" style="margin-top:15px;">পোস্ট করুন</button>
        </div>
    </div>

    <div id="name-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">নাম পরিবর্তন</h3>
            <input type="text" id="new-fullname-input" class="form-control" placeholder="নতুন নাম লিখুন">
            <div class="modal-actions">
                <button class="btn btn-outline" style="width:auto;" onclick="closeModal('name-modal')">বাতিল</button>
                <button class="btn" style="width:auto;" id="save-name-btn">সেভ করুন</button>
            </div>
        </div>
    </div>

    <!-- New Bio Modal -->
    <div id="bio-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">বায়ো পরিবর্তন</h3>
            <textarea id="new-bio-input" class="form-control" rows="3" placeholder="আপনার বায়ো লিখুন..."></textarea>
            <div class="modal-actions">
                <button class="btn btn-outline" style="width:auto;" onclick="closeModal('bio-modal')">বাতিল</button>
                <button class="btn" style="width:auto;" id="save-bio-btn">আপডেট</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">পাসওয়ার্ড পরিবর্তন</h3>
            <input type="password" id="modal-current-pass" class="form-control" placeholder="বর্তমান পাসওয়ার্ড" style="margin-bottom:10px;">
            <input type="password" id="modal-new-pass" class="form-control" placeholder="নতুন পাসওয়ার্ড">
            <div class="modal-actions">
                <button class="btn btn-outline" style="width:auto;" onclick="closeModal('password-modal')">বাতিল</button>
                <button class="btn" style="width:auto;" id="save-pass-btn">পরিবর্তন করুন</button>
            </div>
        </div>
    </div>
    
    <div id="edit-text-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">এডিট করুন</h3>
            <input type="text" id="edit-text-input" class="form-control" placeholder="লিখুন...">
            <input type="hidden" id="edit-target-id">
            <input type="hidden" id="edit-target-collection">
            <input type="hidden" id="edit-parent-id">
            <div class="modal-actions">
                <button class="btn btn-outline" style="width:auto;" onclick="closeModal('edit-text-modal')">বাতিল</button>
                <button class="btn" style="width:auto;" id="save-edit-btn">আপডেট</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3U9bOTNl1KZk_ncwjQj-6CFKzsTvfjJE",
            authDomain: "golposharex.firebaseapp.com",
            projectId: "golposharex",
            storageBucket: "golposharex.appspot.com",
            messagingSenderId: "797216316412",
            appId: "1:797216316412:web:e278c5075d5b83f5ee3079",
            measurementId: "G-TCPHD5HCGZ"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUserData = {};
        let activeChatUnsubscribe = null;
        let notifUnsubscribe = null; // <--- এই লাইনটি নতুন যোগ করুন
        let sessionTimer = null; // For tracking browse time
        
        // Dynamic Points System
        let activityPoints = {
            post: 10,
            like: 2,
            comment: 5,
            browse: 1
        };
        
        // Withdrawal Fees Defaults
        let withdrawFees = {
            wmt: 0,
            others: 2.5
        };

        const DEFAULT_PROFILE_PIC = 'https://res.cloudinary.com/dzmo138qb/image/upload/v1763471321/images_19_iteqms.jpg';
        const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dntvrm1wn/image/upload';
        const CLOUDINARY_UPLOAD_PRESET = 'ml_default';

        // --- UI HELPERS ---
        
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Toggle Button Loading State
        function setBtnLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            if(isLoading) {
                btn.classList.add('btn-loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        function formatPostTime(timestamp) {
            if (!timestamp) return 'Just now';
            const date = new Date(timestamp.seconds * 1000);
            const now = new Date();
            const diff = now - date;
            const days = diff / (1000 * 60 * 60 * 24);
            const hours = diff / (1000 * 60 * 60);
            const minutes = diff / (1000 * 60);

            if (days > 7) {
                return date.toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            } else if (days >= 1) {
                return Math.floor(days) + ' days ago';
            } else if (hours >= 1) {
                return Math.floor(hours) + 'h ago';
            } else if (minutes >= 1) {
                return Math.floor(minutes) + ' min ago';
            } else {
                return 'Just now';
            }
        }

        function getVerificationHtml(isVerified, badgeExpiry) {
            if (!isVerified) return '';
            if (badgeExpiry && badgeExpiry.seconds * 1000 < Date.now()) {
                return ''; // Expired
            }
            return '<i class="fas fa-check-circle verified-badge" title="Verified"></i>';
        }

        function getRoleHtml(role) {
            if (!role || role === 'user') return '';
            return `<span class="role-badge role-${role}">${role}</span>`;
        }
        
        // Feature 4: Rich Text Processor (Links, YouTube, Mentions)
        function processText(text) {
            if (!text) return '';
            let processed = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

            // YouTube Embed
            const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/g;
            processed = processed.replace(ytRegex, '<iframe class="youtube-embed" src="https://www.youtube.com/embed/$1" allowfullscreen></iframe>');

            // URL Linking (exclude youtube as it is already handled or allow text link too)
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            // We use a temporary placeholder to avoid double-linking the iframe src
            processed = processed.replace(urlRegex, (url) => {
                if (url.includes('youtube.com/embed')) return url;
                return `<a href="${url}" target="_blank" class="detected-link">${url}</a>`;
            });

            // Mentions (@Name)
            // This is a simple visual logic. Real mentioning needs User ID storage.
            const mentionRegex = /@(\w+)/g;
            processed = processed.replace(mentionRegex, '<span class="user-mention">@$1</span>');

            return processed;
        }
        
        // Load Admin Settings (Points, Rewards, Fees)
        async function loadSystemSettings() {
            try {
                const doc = await db.collection('system').doc('settings').get();
                if (doc.exists) {
                    const data = doc.data();
                    if(data.points_post) activityPoints.post = data.points_post;
                    if(data.points_like) activityPoints.like = data.points_like;
                    if(data.points_comment) activityPoints.comment = data.points_comment;
                    if(data.points_browse) activityPoints.browse = data.points_browse;
                    if(data.withdraw_fee_mfs) withdrawFees.others = parseFloat(data.withdraw_fee_mfs);
                }
            } catch(e) {
                console.log("Using default settings.");
            }
        }

        function navigateTo(newPageId, addToHistory = true) {
            document.querySelectorAll('.auth-container').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.app-view, .chat-interface, .search-overlay').forEach(el => el.classList.add('d-none'));
            
            if (newPageId !== 'login-page' && newPageId !== 'signup-page') {
                document.getElementById('app-header').classList.remove('d-none');
                document.getElementById(newPageId).classList.remove('d-none');
            } else {
                document.getElementById('app-header').classList.add('d-none');
                document.getElementById(newPageId).classList.remove('d-none');
            }
            window.scrollTo(0,0);
            if (addToHistory) {
                history.pushState({ page: newPageId }, "", `#${newPageId.replace('-page', '')}`);
            }
        }

        window.onpopstate = function(event) {
            if (event.state && event.state.page) {
                navigateTo(event.state.page, false);
            } else {
                if (auth.currentUser) navigateTo('home-page', false);
                else navigateTo('login-page', false);
            }
        };

        // --- AUTH & INIT ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                await loadSystemSettings();
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    if (data.isDisabled === true) {
                        await auth.signOut();
                        alert("আপনার অ্যাকাউন্টটি নিষ্ক্রিয় (Disabled) করা হয়েছে।");
                        document.getElementById('global-loader').style.display = 'none';
                        return;
                    }
                    currentUserData = data;
                    updateHeaderProfile(currentUserData);
                    initNotificationListener(user.uid);
                    startSessionTracking(user.uid); 
                    navigateTo('home-page');
                    loadNewsfeedPosts(); 
                } else {
                    logout();
                }
            } else {
                // যদি ইউজার না থাকে, লিসেনারগুলো বন্ধ করে দিন
                if (notifUnsubscribe) notifUnsubscribe();
                if (activeChatUnsubscribe) activeChatUnsubscribe();
                
                currentUserData = {};
                stopSessionTracking();
                navigateTo('login-page', false);
            }
            
            setTimeout(() => {
                document.getElementById('global-loader').style.display = 'none';
            }, 500);
        });

        function updateHeaderProfile(data) {
            const picUrl = data.profilePicURL || DEFAULT_PROFILE_PIC;
            document.getElementById('header-profile-pic').src = picUrl;
            document.getElementById('trigger-user-pic').src = picUrl;
        }

        // --- NOTIFICATION SYSTEM ---
        function initNotificationListener(uid) {
            // আগের কোনো লিসেনার চালু থাকলে তা বন্ধ করুন
            if (notifUnsubscribe) {
                notifUnsubscribe();
                notifUnsubscribe = null;
            }

            // নতুন লিসেনার ভেরিয়েবলে রাখুন
            notifUnsubscribe = db.collection('users').doc(uid).collection('notifications')
                .orderBy('createdAt', 'desc')
                .limit(20)
                .onSnapshot(snapshot => {
                    const notifContainer = document.getElementById('notification-dropdown');
                    const badge = document.getElementById('notif-badge');
                    let unreadCount = 0;
                    notifContainer.innerHTML = '';
                    if(snapshot.empty) {
                        notifContainer.innerHTML = '<div style="padding:10px; text-align:center; color:#777;">কোনো নতুন নোটিফিকেশন নেই</div>';
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!data.read) unreadCount++;
                        const senderName = data.senderName || 'System';
                        const senderPic = data.senderPic || (data.senderName ? DEFAULT_PROFILE_PIC : 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png');
                        
                        const item = document.createElement('div');
                        item.className = `notification-item ${!data.read ? 'unread' : ''}`;
                        item.innerHTML = `
                            <img src="${senderPic}" class="notif-pic">
                            <div><strong>${senderName}</strong> ${getNotifText(data)}</div>
                        `;
                        item.onclick = () => handleNotificationClick(doc.id, data);
                        notifContainer.appendChild(item);
                    });
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.classList.add('show');
                    } else {
                        badge.classList.remove('show');
                    }
                }, error => {
                    // এরর হ্যান্ডলিং: যাতে কনসোলে লাল দাগ না আসে
                    console.log("Notification listener stopped.");
                });
        }

        function getNotifText(data) {
    // যদি data.type না থাকে তবে ধরে নিচ্ছি data নিজেই টাইপ (পুরানো কোডের জন্য)
    const type = data.type || data; 
    
    if (type === 'like') return 'আপনার পোস্টে লাইক দিয়েছেন।';
    if (type === 'comment') return 'আপনার পোস্টে কমেন্ট করেছেন।';
    if (type === 'reply') return 'আপনার কমেন্টের রিপ্লাই দিয়েছেন।';
    if (type === 'follow') return 'আপনাকে ফলো করছেন।';
    if (type === 'reward') return 'লিডারবোর্ড রিওয়ার্ড!';
    if (type === 'deposit') return 'আপনার ডিপোজিট কনফার্ম হয়েছে!';
    if (type === 'deposit_reject') return 'আপনার ডিপোজিট বাতিল হয়েছে।';
    if (type === 'withdraw_approve') return 'টাকা উত্তোলন সম্পন্ন হয়েছে।';
    if (type === 'withdraw_reject') return 'টাকা উত্তোলন বাতিল হয়েছে।';
    
    // নতুন: অ্যাডমিন মেসেজ হলে সেই মেসেজটাই দেখাবে
    if (type === 'admin_msg') return data.text; 
    
    return 'আপনাকে একটি নোটিফিকেশন পাঠিয়েছেন।';
}

        async function handleNotificationClick(docId, data) {
    await db.collection('users').doc(auth.currentUser.uid).collection('notifications').doc(docId).update({read: true});
    
    if (data.postId) {
        navigateTo('home-page');
    } 
    else if (data.type === 'admin_msg') {
        // নতুন: অ্যাডমিন মেসেজ হলে পপ-আপ দেখাবে
        alert("Admin Message:\n\n" + data.text);
    }
    else if (data.senderUid) {
        loadUserProfile(data.senderUid);
    }
    else if (data.type === 'deposit' || data.type === 'deposit_reject') {
        navigateTo('subscription-page');
        loadDepositHistory();
    } else if (data.type.includes('withdraw')) {
        navigateTo('withdraw-page');
        loadWithdrawHistory();
    }
}

        async function sendNotification(targetUid, type, postId = null) {
            if (targetUid === auth.currentUser.uid) return;
            await db.collection('users').doc(targetUid).collection('notifications').add({
                type: type,
                senderUid: auth.currentUser.uid,
                senderName: currentUserData.fullName,
                senderPic: currentUserData.profilePicURL,
                postId: postId,
                read: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // --- NEWSFEED & POSTS ---
        function renderPost(doc, isHidden = false) {
            const postData = doc.data();
            const postId = doc.id;
            const postElement = document.createElement('div');
            postElement.classList.add('post');
            postElement.setAttribute('data-post-id', postId);

            const userLiked = postData.likes && postData.likes.includes(auth.currentUser.uid);
            const likedClass = userLiked ? 'liked' : '';
            const heartIconClass = userLiked ? 'fas' : 'far';
            const time = formatPostTime(postData.createdAt);
            const badgeHtml = getVerificationHtml(postData.isVerified, postData.badgeExpiry);
            // Feature 1: Role Badges
            const roleHtml = getRoleHtml(postData.authorRole); 
            
            let statusBadge = '';
            // Logic for Feature 1: Role users show role badge, regular users show nothing special unless pending
            if (postData.status === 'pending' && postData.authorUid === auth.currentUser.uid) {
                statusBadge = '<span class="pending-badge">Pending</span>';
            }
            
            // Post Menu Options
            const isOwner = postData.authorUid === auth.currentUser.uid;
            
            let menuHtml = '';
            if (isHidden) {
                menuHtml = `<div class="post-menu-dropdown">
                                <div class="post-menu-item unhide-post-opt"><i class="fas fa-eye"></i> আন-হাইড করুন</div>
                            </div>`;
            } else {
                menuHtml = `<div class="post-menu-dropdown">
                                ${isOwner ? `<div class="post-menu-item edit-post-opt"><i class="fas fa-edit"></i> এডিট করুন</div>` : ''}
                                ${isOwner ? `<div class="post-menu-item delete-post-opt" style="color:var(--error);"><i class="fas fa-trash"></i> ডিলিট করুন</div>` : ''}
                                <div class="post-menu-item hide-post-opt"><i class="fas fa-eye-slash"></i> হাইড করুন</div>
                                <div class="post-menu-item report-post-opt"><i class="fas fa-flag"></i> রিপোর্ট করুন</div>
                            </div>`;
            }

            // Feature 4: Rich Text Processing
            const processedText = processText(postData.text);

            postElement.innerHTML = `
                <div class="post-header">
                    <img src="${postData.authorProfilePic || DEFAULT_PROFILE_PIC}" class="post-user-pic" onclick="loadUserProfile('${postData.authorUid}')">
                    <div class="post-user-info">
                        <h3 onclick="loadUserProfile('${postData.authorUid}')">${postData.authorName} ${badgeHtml} ${roleHtml}</h3>
                        <p>${time} ${statusBadge}</p>
                    </div>
                    <button class="post-menu-btn"><i class="fas fa-ellipsis-v"></i></button>
                    ${menuHtml}
                </div>
                <div class="post-content">
                    <p>${processedText}</p>
                    ${postData.imageUrl ? `<img src="${postData.imageUrl}" class="post-image">` : ''}
                </div>
                ${!isHidden ? `
                <div class="post-engagement">
                    <button class="engagement-btn like-btn">
                        <i class="${heartIconClass} fa-heart ${likedClass}"></i> 
                        <span class="like-count">${formatCount(postData.likes ? postData.likes.length : 0)}</span>
                    </button>
                    <button class="engagement-btn comment-btn">
                        <i class="far fa-comment"></i> <span class="comment-count">${formatCount(postData.commentsCount || 0)}</span>
                    </button>
                    <button class="engagement-btn share-btn">
                        <i class="far fa-share-square"></i> Share
                    </button>
                </div>
                <div class="comment-section">
                    <div class="comments-list"></div>
                    <div class="replying-to-alert"></div>
                    <form class="add-comment-form">
                        <input type="text" class="comment-input" placeholder="কমেন্ট করুন..." required>
                        <input type="hidden" class="comment-reply-id">
                        <input type="hidden" class="comment-reply-name">
                        <button type="submit" class="comment-submit-btn"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>` : ''}`;
            return postElement;
        }

        // Create Post Logic
        document.getElementById('create-post-trigger').addEventListener('click', () => {
            document.getElementById('modal-post-input').value = '';
            document.getElementById('modal-file-input').value = '';
            document.getElementById('modal-image-preview').style.display = 'none';
            document.getElementById('modal-user-pic').src = currentUserData.profilePicURL || DEFAULT_PROFILE_PIC;
            document.getElementById('modal-user-name').textContent = currentUserData.fullName;
            openModal('create-post-modal');
            setTimeout(() => document.getElementById('modal-post-input').focus(), 100);
        });
        
        document.getElementById('modal-add-photo').addEventListener('click', () => document.getElementById('modal-file-input').click());
        
        document.getElementById('modal-file-input').addEventListener('change', function(e) {
            if(this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img-elem').src = e.target.result;
                    document.getElementById('modal-image-preview').style.display = 'block';
                }
                reader.readAsDataURL(this.files[0]);
            }
        });

        document.getElementById('modal-submit-post').addEventListener('click', async () => {
            const textInput = document.getElementById('modal-post-input');
            const fileInput = document.getElementById('modal-file-input');
            const btn = document.getElementById('modal-submit-post');
            if(!textInput.value.trim() && !fileInput.files[0]) return;
            
            btn.disabled = true;
            btn.textContent = 'পোস্ট হচ্ছে...';
            try {
                let imgUrl = '';
                if(fileInput.files[0]) imgUrl = await uploadToCloudinary(fileInput.files[0]);
                
                // Feature 1: Role Based Auto Approval
                const roles = ['admin', 'moderator', 'editor', 'adviser'];
                const userRole = currentUserData.role || 'user';
                const isAutoApproved = roles.includes(userRole);
                const postStatus = isAutoApproved ? 'approved' : 'pending';

                await db.collection('posts').add({
                    text: textInput.value,
                    imageUrl: imgUrl,
                    authorUid: auth.currentUser.uid,
                    authorName: currentUserData.fullName,
                    authorProfilePic: currentUserData.profilePicURL,
                    authorRole: userRole, // Store Role
                    isVerified: currentUserData.isVerified || false,
                    badgeExpiry: currentUserData.badgeExpiry || null,
                    status: postStatus, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: [], commentsCount: 0, shareCount: 0
                });
                updateActivityScore(auth.currentUser.uid, activityPoints.post, 'post');
                closeModal('create-post-modal');
                
                if(isAutoApproved) {
                    showToast('পোস্ট সফলভাবে করা হয়েছে!');
                    // Refresh newsfeed if on homepage
                    if(!document.getElementById('home-page').classList.contains('d-none')) loadNewsfeedPosts();
                } else {
                    showToast('পোস্ট জমা দেওয়া হয়েছে! এডমিন অনুমোদনের পর দেখা যাবে।');
                }
                if(!document.getElementById('profile-page').classList.contains('d-none')) loadUserPosts(auth.currentUser.uid);
            } catch(e) {
                console.error(e);
                showToast('পোস্ট করতে সমস্যা হয়েছে');
            } finally {
                btn.disabled = false;
                btn.textContent = 'পোস্ট করুন';
            }
        });

        // --- LEADERBOARD & WALLET ---
        function startSessionTracking(uid) {
            if (sessionTimer) clearInterval(sessionTimer);
            sessionTimer = setInterval(() => { if (document.visibilityState === 'visible') updateActivityScore(uid, activityPoints.browse, 'browse'); }, 60000);
        }
        function stopSessionTracking() { if (sessionTimer) clearInterval(sessionTimer); }

        async function updateActivityScore(uid, points, type) {
            const scorePoints = points || 1;
            const leaderboardRef = db.collection('leaderboard').doc(uid);
            try {
                await db.runTransaction(async (t) => {
                    const lbDoc = await t.get(leaderboardRef);
                    let newData = {
                        uid: uid,
                        name: currentUserData.fullName || "User",
                        pic: currentUserData.profilePicURL || DEFAULT_PROFILE_PIC,
                        isVerified: currentUserData.isVerified || false,
                        badgeExpiry: currentUserData.badgeExpiry || null,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        score: firebase.firestore.FieldValue.increment(scorePoints)
                    };
                    if(type === 'post') newData.postsCount = firebase.firestore.FieldValue.increment(1);
                    if(type === 'comment') newData.commentsCount = firebase.firestore.FieldValue.increment(1);
                    if(type === 'like') newData.likesCount = firebase.firestore.FieldValue.increment(1);
                    if(type === 'browse') newData.browseMinutes = firebase.firestore.FieldValue.increment(1);
                    
                    if (!lbDoc.exists) {
                        t.set(leaderboardRef, { 
                            ...newData, score: scorePoints, postsCount: type==='post'?1:0, commentsCount: type==='comment'?1:0, likesCount: type==='like'?1:0, browseMinutes: type==='browse'?1:0 
                        });
                    } else { t.update(leaderboardRef, newData); }
                });
            } catch (e) { console.log(e); }
        }

        async function loadLeaderboard() {
            const listContainer = document.getElementById('leaderboard-list');
            listContainer.innerHTML = '<div style="text-align:center; padding:20px;">লোড হচ্ছে...</div>';
            await checkAndDistributeRewards();
            try {
                const snapshot = await db.collection('leaderboard').orderBy('score', 'desc').limit(10).get();
                listContainer.innerHTML = '';
                let rank = 1;
                let myRankData = null;
                
                if (snapshot.empty) listContainer.innerHTML = '<div style="text-align:center; padding:20px;">এখনও কেউ অ্যাক্টিভিটি শুরু করেনি!</div>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isMe = data.uid === auth.currentUser.uid;
                    if(isMe) myRankData = { rank: rank, score: data.score };
                    let rankClass = '', icon = '';
                    if(rank === 1) { rankClass = 'rank-1'; icon = '<i class="fas fa-crown"></i>'; }
                    else if(rank === 2) { rankClass = 'rank-2'; icon = '<i class="fas fa-medal"></i>'; }
                    else if(rank === 3) { rankClass = 'rank-3'; icon = '<i class="fas fa-medal"></i>'; }
                    const badgeHtml = getVerificationHtml(data.isVerified, data.badgeExpiry);
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    if(isMe) item.style.backgroundColor = '#e3f2fd';
                    item.innerHTML = `
                        <div class="rank-num ${rankClass}">${icon || rank}</div>
                        <div class="lb-user-info" onclick="loadUserProfile('${data.uid}')" style="cursor:pointer;">
                            <img src="${data.pic || DEFAULT_PROFILE_PIC}" class="lb-pic">
                            <div>
                                <div style="font-weight:600; font-size:15px;">${data.name} ${badgeHtml}</div>
                                <div class="lb-stats-mini">Posts: ${data.postsCount||0} • Likes: ${data.likesCount||0} • Min: ${data.browseMinutes||0}</div>
                            </div>
                        </div>
                        <div class="lb-score">${data.score} pts</div>
                    `;
                    listContainer.appendChild(item);
                    rank++;
                });
                if(!myRankData) {
                    const myDoc = await db.collection('leaderboard').doc(auth.currentUser.uid).get();
                    if(myDoc.exists) {
                        document.getElementById('my-score-display').textContent = `স্কোর: ${myDoc.data().score}`;
                        document.getElementById('my-rank-display').textContent = 'Top 10 এর বাইরে';
                    } else {
                        document.getElementById('my-score-display').textContent = 'স্কোর: 0';
                        document.getElementById('my-rank-display').textContent = '-';
                    }
                } else {
                    document.getElementById('my-score-display').textContent = `স্কোর: ${myRankData.score}`;
                    document.getElementById('my-rank-display').textContent = `#${myRankData.rank}`;
                }
            } catch (e) { console.error(e); }
        }

        async function checkAndDistributeRewards() {
            const metaRef = db.collection('system').doc('leaderboard_meta');
            const metaDoc = await metaRef.get();
            const now = Date.now();
            const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;
            
            // DYNAMIC REWARD AMOUNT from Admin Settings
            let rewardAmount = 0.70; // Default
            const settingsDoc = await db.collection('system').doc('settings').get();
            if(settingsDoc.exists && settingsDoc.data().reward_amount) {
                rewardAmount = parseFloat(settingsDoc.data().reward_amount);
            }
            document.getElementById('lb-reward-info').innerText = `সেরা ৩ জন প্রতি সপ্তাহে পাবে $${rewardAmount}!`;

            let nextReset = now; 
            if (metaDoc.exists) nextReset = metaDoc.data().nextReset.toMillis();
            else {
                await metaRef.set({ nextReset: firebase.firestore.Timestamp.fromMillis(now + ONE_WEEK_MS) });
                return;
            }

            if (now > nextReset) {
                const top3 = await db.collection('leaderboard').orderBy('score', 'desc').limit(3).get();
                if(!top3.empty) {
                    const batch = db.batch();
                    top3.forEach(doc => {
                        const uid = doc.data().uid;
                        batch.update(db.collection('users').doc(uid), { walletBalance: firebase.firestore.FieldValue.increment(rewardAmount) });
                        batch.set(db.collection('users').doc(uid).collection('notifications').doc(), {
                            type: 'reward', text: `অভিনন্দন! আপনি সাপ্তাহিক লিডারবোর্ডে সেরা হয়ে $${rewardAmount} জিতেছেন!`, read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    // Reset everyone
                    const activeUsers = await db.collection('leaderboard').limit(50).get();
                    activeUsers.forEach(doc => { batch.update(doc.ref, { score: 0, postsCount: 0, likesCount: 0, commentsCount: 0, browseMinutes: 0 }); });
                    batch.update(metaRef, { nextReset: firebase.firestore.Timestamp.fromMillis(now + ONE_WEEK_MS) });
                    await batch.commit();
                    showToast('নতুন সপ্তাহ শুরু হয়েছে! বিজয়ীদের রিওয়ার্ড দেওয়া হয়েছে।');
                }
            }
        }
        
        async function loadWallet() {
            const balanceEl = document.getElementById('wallet-balance');
            const transList = document.getElementById('transaction-list');
            const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
            const balance = userDoc.data().walletBalance || 0.00;
            balanceEl.textContent = `$${balance.toFixed(2)}`;
            
            transList.innerHTML = '<p style="text-align:center;">লোড হচ্ছে...</p>';
            
            try {
                const deposits = await db.collection('deposit_requests')
                    .where('uid', '==', auth.currentUser.uid)
                    .orderBy('createdAt', 'desc').limit(5).get();
                
                transList.innerHTML = '';
                if(deposits.empty) {
                     transList.innerHTML = '<p style="color:#777; text-align:center;">কোনো লেনদেন পাওয়া যায়নি</p>';
                } else {
                    deposits.forEach(doc => {
                        const d = doc.data();
                        const div = document.createElement('div');
                        div.className = 'dropdown-item';
                        div.style.justifyContent = 'space-between';
                        div.style.cursor = 'default';
                        let color = d.status === 'approved' ? 'green' : (d.status === 'rejected' ? 'red' : 'orange');
                        div.innerHTML = `
                            <div>
                                <strong>Add Money</strong><br>
                                <span style="font-size:12px; color:#777;">TRX: ${d.trxId}</span>
                            </div>
                            <div style="text-align:right;">
                                <strong>$${d.amount}</strong><br>
                                <span style="font-size:12px; color:${color};">${d.status.toUpperCase()}</span>
                            </div>
                        `;
                        transList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error("Wallet History Error (Index Missing?):", error);
                transList.innerHTML = '<p style="color:red; text-align:center; font-size:12px;">হিস্ট্রি লোড করতে সমস্যা। কনসোল চেক করুন (Index Error)</p>';
            }
        }
        
        // --- ADD MONEY LOGIC ---
        function copyWmtId() {
            const text = document.getElementById('wmt-id-text').innerText;
            navigator.clipboard.writeText(text).then(() => showToast("WMT ID কপি হয়েছে!"));
        }
        window.copyWmtId = copyWmtId;

        document.getElementById('deposit-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const trxId = document.getElementById('deposit-trx-id').value.trim();
            
            if(!amount || !trxId) return showToast("সব তথ্য পূরণ করুন");
            
            setBtnLoading('deposit-btn', true);
            
            try {
                await db.collection('deposit_requests').add({
                    uid: auth.currentUser.uid,
                    userName: currentUserData.fullName,
                    amount: amount,
                    trxId: trxId,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("রিকুয়েষ্ট পাঠানো হয়েছে! এডমিন চেক করে ব্যালেন্স যোগ করবেন।");
                document.getElementById('add-money-form').reset();
                loadDepositHistory();
            } catch(e) {
                showToast("সমস্যা হয়েছে: " + e.message);
            } finally {
                setBtnLoading('deposit-btn', false);
            }
        });

        async function loadDepositHistory() {
            const list = document.getElementById('deposit-history-list');
            list.innerHTML = '<p style="text-align:center;">লোড হচ্ছে...</p>';
            
            try {
                const snap = await db.collection('deposit_requests')
                    .where('uid', '==', auth.currentUser.uid)
                    .orderBy('createdAt', 'desc').limit(10).get();
                    
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<p style="color:#777; text-align:center; padding:10px;">কোনো ডিপোজিট হিস্ট্রি নেই</p>';
                } else {
                    snap.forEach(doc => {
                        const d = doc.data();
                        const div = document.createElement('div');
                        div.style.padding = "10px";
                        div.style.borderBottom = "1px solid #eee";
                        div.style.display = "flex";
                        div.style.justifyContent = "space-between";
                        
                        let statusClass = d.status === 'approved' ? 'status-approved' : (d.status === 'rejected' ? 'status-rejected' : 'status-pending');
                        
                        div.innerHTML = `
                            <div>
                                <div style="font-weight:600;">$${d.amount} Deposit</div>
                                <div style="font-size:12px; color:#888;">TRX: ${d.trxId}</div>
                            </div>
                            <div style="text-align:right;">
                                <div class="${statusClass}">${d.status.toUpperCase()}</div>
                                <div style="font-size:10px; color:#888;">${formatPostTime(d.createdAt)}</div>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }
            } catch (error) {
                console.error("Deposit History Error (Index Missing?):", error);
                list.innerHTML = '<p style="color:red; text-align:center; font-size:12px;">ডাটাবেস ইনডেক্স তৈরি করা প্রয়োজন (Console Check)</p>';
            }
        }

        // --- WITHDRAW LOGIC ---
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const withdrawMethodInput = document.getElementById('withdraw-method');
        
        function calculateWithdrawFee() {
            const amount = parseFloat(withdrawAmountInput.value);
            const method = withdrawMethodInput.value;
            const displayFee = document.getElementById('withdraw-fee-info');
            const displayNet = document.getElementById('withdraw-net-display');
            
            if (!amount || !method) {
                displayFee.textContent = '';
                displayNet.textContent = '';
                return;
            }
            
            let feePercent = 0;
            if (method === 'wmt') feePercent = withdrawFees.wmt; 
            else feePercent = withdrawFees.others; 
            
            const feeAmount = (amount * feePercent) / 100;
            const netAmount = amount - feeAmount;
            
            displayFee.textContent = `ফি: $${feeAmount.toFixed(2)} (${feePercent}%)`;
            displayNet.textContent = `পাবেন: $${netAmount.toFixed(2)}`;
        }
        
        withdrawAmountInput.addEventListener('input', calculateWithdrawFee);
        withdrawMethodInput.addEventListener('change', calculateWithdrawFee);

        document.getElementById('withdraw-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const amount = parseFloat(withdrawAmountInput.value);
            const method = withdrawMethodInput.value;
            const account = document.getElementById('withdraw-account').value.trim();
            
            if(!amount || !method || !account) return showToast("সব তথ্য পূরণ করুন");
            
            const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
            const currentBal = userDoc.data().walletBalance || 0;
            
            if(amount > currentBal) return showToast("অপর্যাপ্ত ব্যালেন্স!");
            if(amount < 1) return showToast("মিনিমাম $1 উত্তোলন করতে হবে"); 
            
            setBtnLoading('withdraw-btn', true);
            
            try {
                let feePercent = (method === 'wmt') ? withdrawFees.wmt : withdrawFees.others;
                const feeAmount = (amount * feePercent) / 100;
                const netAmount = amount - feeAmount;

                await db.runTransaction(async (t) => {
                    const userRef = db.collection('users').doc(auth.currentUser.uid);
                    const uDoc = await t.get(userRef);
                    if(uDoc.data().walletBalance < amount) throw "Insufficient Balance";
                    
                    t.update(userRef, { walletBalance: firebase.firestore.FieldValue.increment(-amount) });
                    
                    const reqRef = db.collection('withdraw_requests').doc();
                    t.set(reqRef, {
                        uid: auth.currentUser.uid,
                        userName: currentUserData.fullName,
                        amount: amount,
                        fee: feeAmount,
                        netAmount: netAmount,
                        method: method,
                        account: account,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                showToast("উত্তোলন রিকুয়েষ্ট সফল হয়েছে!");
                document.getElementById('withdraw-form').reset();
                document.getElementById('withdraw-fee-info').textContent = '';
                document.getElementById('withdraw-net-display').textContent = '';
                loadWithdrawHistory();
                document.getElementById('withdraw-balance').textContent = `$${(currentBal - amount).toFixed(2)}`;

            } catch(e) {
                showToast("সমস্যা হয়েছে: " + e);
            } finally {
                setBtnLoading('withdraw-btn', false);
            }
        });

        async function loadWithdrawHistory() {
            const list = document.getElementById('withdraw-history-list');
            list.innerHTML = '<p style="text-align:center;">লোড হচ্ছে...</p>';
            
            try {
                const snap = await db.collection('withdraw_requests')
                    .where('uid', '==', auth.currentUser.uid)
                    .orderBy('createdAt', 'desc').limit(10).get();
                
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<p style="color:#777; text-align:center; padding:10px;">কোনো ইতিহাস নেই</p>';
                } else {
                    snap.forEach(doc => {
                        const d = doc.data();
                        const div = document.createElement('div');
                        div.style.padding = "10px";
                        div.style.borderBottom = "1px solid #eee";
                        div.style.display = "flex";
                        div.style.justifyContent = "space-between";
                        
                        let statusClass = d.status === 'approved' ? 'status-approved' : (d.status === 'rejected' ? 'status-rejected' : 'status-pending');
                        
                        div.innerHTML = `
                            <div>
                                <div style="font-weight:600;">$${d.amount} Withdraw</div>
                                <div style="font-size:12px; color:#888;">${d.method.toUpperCase()} - ${d.account}</div>
                            </div>
                            <div style="text-align:right;">
                                <div class="${statusClass}">${d.status.toUpperCase()}</div>
                                <div style="font-size:10px; color:#888;">${formatPostTime(d.createdAt)}</div>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }
                const u = await db.collection('users').doc(auth.currentUser.uid).get();
                document.getElementById('withdraw-balance').textContent = `$${(u.data().walletBalance || 0).toFixed(2)}`;

            } catch (error) {
                console.error("Withdraw History Error (Index Missing?):", error);
                list.innerHTML = '<p style="color:red; text-align:center; font-size:12px;">ডাটাবেস ইনডেক্স তৈরি করা প্রয়োজন (Console Check)</p>';
            }
        }

        // --- HIDDEN POSTS LOGIC ---
        async function loadHiddenPosts() {
            const container = document.getElementById('hidden-posts-list');
            container.innerHTML = '<p style="text-align:center;">লোড হচ্ছে...</p>';
            
            const hiddenSnap = await db.collection('users').doc(auth.currentUser.uid).collection('hidden_posts').orderBy('hiddenAt', 'desc').get();
            
            container.innerHTML = '';
            if(hiddenSnap.empty) {
                container.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">কোনো হাইড করা পোস্ট নেই।</p>';
                return;
            }
            
            for (let doc of hiddenSnap.docs) {
                try {
                    const postDoc = await db.collection('posts').doc(doc.id).get();
                    if(postDoc.exists) {
                        const postEl = renderPost(postDoc, true);
                        container.appendChild(postEl);
                    }
                } catch(e) { console.log("Error loading hidden post", e); }
            }
        }

        // --- PROFILE LOGIC ---
        async function loadUserProfile(targetUid) {
            navigateTo('profile-page');
            const isSelf = targetUid === auth.currentUser.uid;
            
            // এলিমেন্টগুলো সিলেক্ট করা
            const profilePicEl = document.getElementById('profile-pic-large');
            const coverPhotoEl = document.getElementById('profile-cover-photo');
            const editBioBtn = document.getElementById('edit-bio-trigger');
            const followBtn = document.getElementById('follow-btn');
            const msgBtn = document.getElementById('msg-btn');

            // রিসেট (লোডিং স্টেট)
            document.getElementById('profile-name').innerHTML = 'Loading...';
            document.getElementById('profile-bio').textContent = '';
            profilePicEl.src = DEFAULT_PROFILE_PIC;
            coverPhotoEl.style.backgroundImage = 'none';
            
            // --- BUG FIX: আগের ইভেন্ট লিসেনার পরিষ্কার করা ---
            // অন্য কারো প্রোফাইলে গেলে যাতে ক্লিক কাজ না করে, তাই নাল (null) করে দেওয়া হচ্ছে
            profilePicEl.onclick = null;
            coverPhotoEl.onclick = null;
            profilePicEl.style.cursor = 'default';
            coverPhotoEl.style.cursor = 'default';
            // ------------------------------------------------

            editBioBtn.style.display = isSelf ? 'inline-block' : 'none';
            
            // Feature 5: Always show Message Button for others
            msgBtn.style.display = isSelf ? 'none' : 'inline-block';
            followBtn.style.display = isSelf ? 'none' : 'inline-block';

            try {
                let data;
                if (isSelf && currentUserData.uid) data = currentUserData;
                else {
                    const doc = await db.collection('users').doc(targetUid).get();
                    if (!doc.exists) return showToast('User not found');
                    data = doc.data();
                }
                
                // ব্যাজ এবং রোল হ্যান্ডলিং
                const badgeHtml = getVerificationHtml(data.isVerified, data.badgeExpiry);
                // getRoleHtml ফাংশনটি যদি আপনার কোডে থাকে তবেই দেখাবে, না থাকলে এরর দেবে না
                const roleHtml = (typeof getRoleHtml === 'function') ? getRoleHtml(data.role) : ''; 
                
                document.getElementById('profile-name').innerHTML = `${data.fullName} ${badgeHtml} ${roleHtml}`;
                document.getElementById('profile-bio').textContent = data.bio || 'কোনো বায়ো নেই';
                profilePicEl.src = data.profilePicURL || DEFAULT_PROFILE_PIC;
                coverPhotoEl.style.backgroundImage = data.coverPhotoURL ? `url(${data.coverPhotoURL})` : 'none';
                document.getElementById('following-count').textContent = formatCount(data.followingCount || 0);
                document.getElementById('follower-count').textContent = formatCount(data.followerCount || 0);
                document.getElementById('like-count').textContent = formatCount(data.totalLikes || 0);
                loadUserPosts(targetUid);

                if (!isSelf) {
                    // --- অন্যের প্রোফাইল ভিউ লজিক ---
                    const myFollowings = await db.collection('users').doc(auth.currentUser.uid).collection('following').doc(targetUid).get();
                    if (myFollowings.exists) { followBtn.textContent = 'Unfollow'; followBtn.classList.add('btn-outline'); } 
                    else { followBtn.textContent = 'Follow'; followBtn.classList.remove('btn-outline'); }
                    
                    followBtn.onclick = async () => {
                        if (followBtn.textContent === 'Follow') {
                            await db.collection('users').doc(auth.currentUser.uid).collection('following').doc(targetUid).set({});
                            await db.collection('users').doc(auth.currentUser.uid).update({followingCount: firebase.firestore.FieldValue.increment(1)});
                            await db.collection('users').doc(targetUid).collection('followers').doc(auth.currentUser.uid).set({});
                            await db.collection('users').doc(targetUid).update({followerCount: firebase.firestore.FieldValue.increment(1)});
                            sendNotification(targetUid, 'follow');
                            followBtn.textContent = 'Unfollow'; followBtn.classList.add('btn-outline');
                        } else {
                            await db.collection('users').doc(auth.currentUser.uid).collection('following').doc(targetUid).delete();
                            await db.collection('users').doc(auth.currentUser.uid).update({followingCount: firebase.firestore.FieldValue.increment(-1)});
                            await db.collection('users').doc(targetUid).collection('followers').doc(auth.currentUser.uid).delete();
                            await db.collection('users').doc(targetUid).update({followerCount: firebase.firestore.FieldValue.increment(-1)});
                            followBtn.textContent = 'Follow'; followBtn.classList.remove('btn-outline');
                        }
                        const updatedDoc = await db.collection('users').doc(targetUid).get();
                        document.getElementById('follower-count').textContent = formatCount(updatedDoc.data().followerCount || 0);
                    };
                    msgBtn.onclick = () => openChat(targetUid, data.fullName, data.profilePicURL, data.isVerified, data.badgeExpiry);
                
                } else {
                    // --- নিজের প্রোফাইল ভিউ লজিক (এখানেই ফিক্স কাজ করবে) ---
                    
                    // কার্সার পয়েন্টার করা
                    profilePicEl.style.cursor = 'pointer';
                    coverPhotoEl.style.cursor = 'pointer';

                    editBioBtn.onclick = () => { document.getElementById('new-bio-input').value = data.bio || ''; openModal('bio-modal'); };
                    
                    // নতুন ক্লিক ইভেন্ট সেট করা
                    profilePicEl.onclick = () => document.getElementById('profile-pic-input').click();
                    
                    coverPhotoEl.onclick = (e) => { 
                        if(e.target.id === 'profile-cover-photo') document.getElementById('cover-photo-input').click(); 
                    };

                    // ইনপুট চেঞ্জ হ্যান্ডলার
                    document.getElementById('profile-pic-input').onchange = async (e) => {
    if(e.target.files[0]) {
        document.getElementById('pic-spinner').style.display = 'block';
        try { 
            const url = await uploadToCloudinary(e.target.files[0]); 
            
            // ১. মেইন ইউজার ডকুমেন্ট আপডেট
            await db.collection('users').doc(auth.currentUser.uid).update({ profilePicURL: url }); 
            
            // ২. লোকাল ভেরিয়েবল আপডেট
            currentUserData.profilePicURL = url; 
            profilePicEl.src = url; 
            document.getElementById('header-profile-pic').src = url; 
            document.getElementById('trigger-user-pic').src = url; 
            
            showToast('প্রোফাইল ছবি আপডেট হচ্ছে...'); 
            
            // ৩. সব পোস্ট এবং কমেন্ট আপডেট কল করা (NEW ADDITION)
            await updateUserProfileGlobally({ profilePicURL: url });
            
            showToast('প্রোফাইল ছবি সব জায়গায় আপডেট সম্পন্ন!');
            
        } catch(err) { 
            console.error(err);
            showToast('ব্যর্থ হয়েছে'); 
        }
        document.getElementById('pic-spinner').style.display = 'none';
        e.target.value = ''; // ইনপুট রিসেট
    }
};
                    
                    document.getElementById('cover-photo-input').onchange = async (e) => {
                         if(e.target.files[0]) {
                            document.getElementById('cover-spinner').style.display = 'block';
                            try { 
                                const url = await uploadToCloudinary(e.target.files[0]); 
                                await db.collection('users').doc(auth.currentUser.uid).update({ coverPhotoURL: url }); 
                                coverPhotoEl.style.backgroundImage = `url(${url})`; 
                                showToast('কভার ফটো আপডেট হয়েছে!'); 
                            } catch(err) { showToast('ব্যর্থ হয়েছে'); }
                            document.getElementById('cover-spinner').style.display = 'none';
                            e.target.value = ''; // ইনপুট রিসেট
                        }
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function loadNewsfeedPosts() {
            const container = document.getElementById('newsfeed-container');
            Array.from(container.children).forEach(child => { if (!child.classList.contains('create-post-trigger-box')) child.remove(); });
            const snapshot = await db.collection('posts').where('status', '==', 'approved').orderBy('createdAt', 'desc').limit(10).get();
            snapshot.forEach(doc => container.appendChild(renderPost(doc)));
        }

        async function loadUserPosts(uid) {
            const container = document.getElementById('user-posts-container');
            container.innerHTML = '<h3 style="text-align: center; color: var(--text-light); margin-bottom: 20px; font-size:16px;">পোস্টসমূহ</h3>';
            let snapshot;
            if (uid === auth.currentUser.uid) snapshot = await db.collection('posts').where('authorUid', '==', uid).orderBy('createdAt', 'desc').limit(10).get();
            else snapshot = await db.collection('posts').where('authorUid', '==', uid).where('status', '==', 'approved').orderBy('createdAt', 'desc').limit(10).get();
            
            if(snapshot.empty) container.innerHTML += '<p style="text-align:center; color:#999;">কোনো পোস্ট নেই</p>';
            else snapshot.forEach(doc => container.appendChild(renderPost(doc)));
        }

        // --- EVENT LISTENERS & GLOBAL ACTIONS ---
        document.body.addEventListener('click', async function(e) {
            // 3-DOT MENU LOGIC
            if(e.target.closest('.post-menu-btn')) {
                const btn = e.target.closest('.post-menu-btn');
                const dropdown = btn.nextElementSibling;
                document.querySelectorAll('.post-menu-dropdown').forEach(el => { if(el !== dropdown) el.classList.remove('show'); });
                dropdown.classList.toggle('show');
                e.stopPropagation();
            } else {
                document.querySelectorAll('.post-menu-dropdown').forEach(el => el.classList.remove('show'));
                // Close Msg Context Menu
                document.querySelectorAll('.msg-context-menu').forEach(el => el.style.display = 'none');
            }
            
            // Delete Post
             if(e.target.closest('.edit-post-opt')) {
                const postEl = e.target.closest('.post');
                const postId = postEl.dataset.postId;
                // পোস্টের বর্তমান টেক্সট নেওয়া
                const currentText = postEl.querySelector('.post-content p').innerText;

                // মডালে ডাটা সেট করা
                document.getElementById('edit-target-id').value = postId;
                document.getElementById('edit-target-collection').value = 'posts'; // কালেকশন নাম 'posts' সেট করা
                document.getElementById('edit-text-input').value = currentText;
                
                // মডাল ওপেন করা
                openModal('edit-text-modal');
            }
            if(e.target.closest('.delete-post-opt')) {
                if(confirm("আপনি কি এই পোস্টটি ডিলিট করতে চান?")) {
                    const postEl = e.target.closest('.post');
                    const postId = postEl.dataset.postId;
                    await db.collection('posts').doc(postId).delete();
                    postEl.remove();
                    showToast("পোস্ট ডিলিট হয়েছে");
                }
            }
            
            // Hide Post
            if(e.target.closest('.hide-post-opt')) {
                const postEl = e.target.closest('.post');
                const postId = postEl.dataset.postId;
                try {
                    await db.collection('users').doc(auth.currentUser.uid).collection('hidden_posts').doc(postId).set({
                        hiddenAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    postEl.style.display = 'none';
                    showToast("পোস্ট হাইড করা হয়েছে");
                } catch(err) { showToast("সমস্যা হয়েছে"); }
            }
            
            // Unhide Post
            if(e.target.closest('.unhide-post-opt')) {
                const postEl = e.target.closest('.post');
                const postId = postEl.dataset.postId;
                try {
                    await db.collection('users').doc(auth.currentUser.uid).collection('hidden_posts').doc(postId).delete();
                    postEl.remove(); // Remove from Hidden list view
                    showToast("পোস্ট আন-হাইড করা হয়েছে");
                } catch(err) { showToast("সমস্যা হয়েছে"); }
            }

             // Report Post
            if(e.target.closest('.report-post-opt')) {
                const postEl = e.target.closest('.post');
                await db.collection('reports').add({
                    postId: postEl.dataset.postId,
                    reporterUid: auth.currentUser.uid,
                    reason: 'User Report',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("রিপোর্ট জমা হয়েছে");
            }

             // Like Logic
             const likeButton = e.target.closest('.like-btn');
             if (likeButton) {
                const postElement = likeButton.closest('.post');
                const postId = postElement.dataset.postId;
                const heart = likeButton.querySelector('.fa-heart');
                const countSpan = likeButton.querySelector('.like-count');
                let currentCount = parseInt(countSpan.textContent);
                const isLiked = heart.classList.contains('liked');
                if(isLiked) { heart.classList.remove('liked', 'fas'); heart.classList.add('far'); countSpan.textContent = currentCount - 1; } 
                else { heart.classList.add('liked', 'fas'); heart.classList.remove('far'); countSpan.textContent = currentCount + 1; }
                try {
                    const postRef = db.collection('posts').doc(postId);
                    const postDoc = await postRef.get();
                    const authorUid = postDoc.data().authorUid;
                    await db.runTransaction(async (transaction) => {
                        const pd = await transaction.get(postRef);
                        const likes = pd.data().likes || [];
                        if (likes.includes(auth.currentUser.uid)) {
                            transaction.update(postRef, { likes: firebase.firestore.FieldValue.arrayRemove(auth.currentUser.uid) });
                            transaction.update(db.collection('users').doc(authorUid), { totalLikes: firebase.firestore.FieldValue.increment(-1) });
                        } else {
                            transaction.update(postRef, { likes: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.uid) });
                            transaction.update(db.collection('users').doc(authorUid), { totalLikes: firebase.firestore.FieldValue.increment(1) });
                            if(authorUid !== auth.currentUser.uid) sendNotification(authorUid, 'like', postId);
                        }
                    });
                    if(!isLiked) updateActivityScore(auth.currentUser.uid, activityPoints.like, 'like');
                } catch (err) {
                    if(isLiked) { heart.classList.add('liked', 'fas'); heart.classList.remove('far'); countSpan.textContent = currentCount; }
                    else { heart.classList.remove('liked', 'fas'); heart.classList.add('far'); countSpan.textContent = currentCount; }
                }
             }

             const commentButton = e.target.closest('.comment-btn');
             if (commentButton) {
                 const section = commentButton.closest('.post').querySelector('.comment-section');
                 section.style.display = section.style.display === 'block' ? 'none' : 'block';
                 if(section.style.display === 'block') loadComments(commentButton.closest('.post').dataset.postId, section.querySelector('.comments-list'));
             }
             
             // Feature 3: Reply Button
             if(e.target.closest('.reply-cmt-btn')) {
                 const btn = e.target.closest('.reply-cmt-btn');
                 const commentDiv = btn.closest('.comment');
                 const authorName = commentDiv.dataset.authorName;
                 const commentId = commentDiv.dataset.commentId;
                 const section = commentDiv.closest('.comment-section');
                 const form = section.querySelector('.add-comment-form');
                 const alert = section.querySelector('.replying-to-alert');
                 
                 section.querySelector('.comment-reply-id').value = commentId;
                 section.querySelector('.comment-reply-name').value = authorName;
                 
                 alert.style.display = 'flex';
                 alert.innerHTML = `<span>Replying to <strong>${authorName}</strong></span> <button onclick="cancelReply(this)" style="margin-left:10px; border:none; background:none; cursor:pointer; color:red;">x</button>`;
                 form.querySelector('.comment-input').focus();
             }
             
             const shareButton = e.target.closest('.share-btn');
             if (shareButton) {
                 const postId = shareButton.closest('.post').dataset.postId;
                 navigator.clipboard.writeText(postId).then(() => showToast("পোস্ট আইডি কপি হয়েছে!"));
             }
        });
        
        function cancelReply(btn) {
            const section = btn.closest('.comment-section');
            section.querySelector('.replying-to-alert').style.display = 'none';
            section.querySelector('.comment-reply-id').value = '';
            section.querySelector('.comment-reply-name').value = '';
        }
        window.cancelReply = cancelReply;

        document.body.addEventListener('submit', async function(e){
            // শুধুমাত্র কমেন্ট ফর্ম হলে কাজ করবে
            if(e.target.classList.contains('add-comment-form')) {
                e.preventDefault();
                const form = e.target;
                const input = form.querySelector('.comment-input');
                const text = input.value.trim();
                const postId = form.closest('.post').dataset.postId;
                const replyId = form.querySelector('.comment-reply-id').value;
                
                if(!text) return;
                const list = form.closest('.post').querySelector('.comments-list');
                
                // ইনপুট রিসেট
                input.value = '';
                if(window.cancelReply) cancelReply(form.querySelector('.comment-submit-btn'));
                
                try {
                    const postRef = db.collection('posts').doc(postId);
                    const postDoc = await postRef.get();
                    
                    // ডাটাবেসে কমেন্ট সেভ করা হচ্ছে (রোল সহ)
                    await postRef.collection('comments').add({
                        text, 
                        authorUid: auth.currentUser.uid, 
                        authorName: currentUserData.fullName, 
                        authorProfilePic: currentUserData.profilePicURL,
                        // --- এই লাইনটি রোল সেভ করবে ---
                        authorRole: currentUserData.role || 'user', 
                        // -----------------------------
                        isVerified: currentUserData.isVerified || false, 
                        badgeExpiry: currentUserData.badgeExpiry || null,
                        replyToId: replyId || null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // কমেন্ট কাউন্ট বাড়ানো
                    await postRef.update({ commentsCount: firebase.firestore.FieldValue.increment(1) });
                    
                    // নোটিফিকেশন
                    if(replyId) {
                         sendNotification(postDoc.data().authorUid, 'reply', postId);
                    } else {
                         sendNotification(postDoc.data().authorUid, 'comment', postId);
                    }
                    
                    // পয়েন্ট আপডেট
                    updateActivityScore(auth.currentUser.uid, activityPoints.comment, 'comment');
                    
                    // সাথে সাথে কমেন্ট লোড করা
                    loadComments(postId, list);

                } catch (err) { 
                    console.error("Comment Error:", err);
                    showToast('কমেন্ট করতে সমস্যা হয়েছে'); 
                }
            }
        });

        async function loadComments(postId, container) {
            container.innerHTML = '';
            const s = await db.collection('posts').doc(postId).collection('comments').orderBy('createdAt', 'asc').get();
            
            let allComments = [];
            s.forEach(doc => {
                allComments.push({ id: doc.id, ...doc.data() });
            });

            // হাইড করা কমেন্ট ফিল্টার করা
            const hiddenCommentIds = new Set();
            allComments.forEach(c => { if (c.isDeleted === true) hiddenCommentIds.add(c.id); });
            allComments.forEach(c => { if (c.replyToId && hiddenCommentIds.has(c.replyToId)) hiddenCommentIds.add(c.id); });

            allComments.forEach(d => {
                if (hiddenCommentIds.has(d.id)) return;

                const div = document.createElement('div'); 
                div.className = `comment ${d.replyToId ? 'reply-indent' : ''}`;
                div.setAttribute('data-comment-id', d.id);
                div.setAttribute('data-author-name', d.authorName);
                
                const isMy = d.authorUid === auth.currentUser.uid;
                const badgeHtml = getVerificationHtml(d.isVerified, d.badgeExpiry);
                
                // --- এই লাইনটি রোল ব্যাজ তৈরি করবে ---
                const roleHtml = (typeof getRoleHtml === 'function') ? getRoleHtml(d.authorRole) : '';
                // ----------------------------------
                
                const processedComment = processText(d.text);
                
                div.innerHTML = `
                    <img src="${d.authorProfilePic}" class="comment-user-pic">
                    <div class="comment-body">
                        <!-- নামের পাশে roleHtml বসানো হলো -->
                        <strong>${d.authorName} ${badgeHtml} ${roleHtml}</strong>
                        <span class="comment-text">${processedComment}</span>
                    </div>
                    <div class="comment-actions">
                        <button class="comment-action-btn reply-cmt-btn">Reply</button>
                        ${isMy ? `<button class="comment-action-btn del-cmt-btn"><i class="fas fa-trash"></i></button>` : ''}
                    </div>`;
                    
                if(isMy) {
                    div.querySelector('.del-cmt-btn').onclick = async () => { 
                        if(!confirm('আপনি কি এই কমেন্টটি মুছে ফেলতে চান?')) return;
                        const btn = div.querySelector('.del-cmt-btn');
                        btn.disabled = true;
                        try {
                            await db.collection('posts').doc(postId).collection('comments').doc(d.id).update({ isDeleted: true });
                            await db.collection('posts').doc(postId).update({ commentsCount: firebase.firestore.FieldValue.increment(-1) });
                            showToast('কমেন্ট মুছে ফেলা হয়েছে');
                            loadComments(postId, container); 
                        } catch(e) {
                            console.error(e);
                            showToast('সমস্যা হয়েছে');
                            btn.disabled = false;
                        }
                    };
                }
                container.appendChild(div);
            });
        }

        function formatCount(num) { if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'; if (num >= 1000) return (num / 1000).toFixed(1) + 'K'; return num; }
        async function uploadToCloudinary(file) {
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
            const data = await response.json(); return data.secure_url;
        }
        async function logout() { 
            stopSessionTracking();
            
            // নোটিফিকেশন লিসেনার বন্ধ করা
            if (notifUnsubscribe) {
                notifUnsubscribe();
                notifUnsubscribe = null;
            }
            
            // চ্যাট লিসেনার বন্ধ করা
            if (activeChatUnsubscribe) {
                activeChatUnsubscribe();
                activeChatUnsubscribe = null;
            }

            await auth.signOut(); 
            navigateTo('login-page'); 
        }
        document.getElementById('nav-logout').addEventListener('click', logout);

        // MODALS
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        window.closeModal = closeModal;

        document.getElementById('open-name-modal').addEventListener('click', () => openModal('name-modal'));
        document.getElementById('save-name-btn').addEventListener('click', async () => {
    const newName = document.getElementById('new-fullname-input').value;
    const btn = document.getElementById('save-name-btn'); // বাটন ডিসেবল করার জন্য
    
    if(newName.trim()) { 
        // বাটন লোডিং স্ট্যাটাস
        btn.textContent = "আপডেট হচ্ছে...";
        btn.disabled = true;

        try {
            // ১. মেইন ইউজার প্রোফাইল আপডেট
            await db.collection('users').doc(auth.currentUser.uid).update({ fullName: newName }); 
            currentUserData.fullName = newName; 
            
            // ২. পুরনো সব পোস্ট আপডেট করা (নতুন ফাংশন কল)
            showToast('প্রোফাইল আপডেট হয়েছে! পুরনো পোস্টগুলো ঠিক করা হচ্ছে...');
            await updateUserProfileGlobally({ fullName: newName });
            
            closeModal('name-modal'); 
            showToast('নাম এবং সকল পোস্ট সফলভাবে পরিবর্তন হয়েছে!');
            
            // ৩. পেজ রিফ্রেশ বা নাম আপডেট দেখানো
            document.getElementById('profile-name').innerHTML = newName + getVerificationHtml(currentUserData.isVerified, currentUserData.badgeExpiry);
            
            // যদি নিউজফিড খোলা থাকে তবে রিফ্রেশ করুন
            if(!document.getElementById('home-page').classList.contains('d-none')) {
                loadNewsfeedPosts();
            }
            
        } catch (e) {
            console.error(e);
            showToast('সামান্য ত্রুটি হয়েছে: ' + e.message);
        } finally {
            btn.textContent = "সেভ করুন";
            btn.disabled = false;
        }
    }
});

      // --- Bio Save Logic (New) ---
    document.getElementById('save-bio-btn').addEventListener('click', async () => {
        const newBio = document.getElementById('new-bio-input').value.trim();
        const btn = document.getElementById('save-bio-btn');
        
        // বাটন লোডিং ইফেক্ট
        btn.textContent = "আপডেট হচ্ছে...";
        btn.disabled = true;

        try {
            // ১. ডাটাবেসে আপডেট করা
            await db.collection('users').doc(auth.currentUser.uid).update({
                bio: newBio
            });

            // ২. লোকাল ভেরিয়েবল ও প্রোফাইল পেজ আপডেট করা
            currentUserData.bio = newBio;
            document.getElementById('profile-bio').textContent = newBio || 'কোনো বায়ো নেই';
            
            // ৩. মডাল বন্ধ ও সাকসেস মেসেজ
            closeModal('bio-modal');
            showToast('বায়ো সফলভাবে আপডেট হয়েছে!');

        } catch (e) {
            console.error(e);
            showToast('সমস্যা হয়েছে: ' + e.message);
        } finally {
            // বাটন আগের অবস্থায় ফেরত আনা
            btn.textContent = "আপডেট";
            btn.disabled = false;
        }
    });
        document.getElementById('open-password-modal').addEventListener('click', () => openModal('password-modal'));
        document.getElementById('save-pass-btn').addEventListener('click', async () => {
            const currentPass = document.getElementById('modal-current-pass').value;
            const newPass = document.getElementById('modal-new-pass').value;
            if(currentPass && newPass) { try { const cred = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, currentPass); await auth.currentUser.reauthenticateWithCredential(cred); await auth.currentUser.updatePassword(newPass); closeModal('password-modal'); showToast('পাসওয়ার্ড সফলভাবে পরিবর্তন হয়েছে!'); } catch(e) { showToast('ত্রুটি: ' + e.message); } }
        });
        
        // Feature 2: Edit/Delete Message & Post Logic (UPDATED)
        document.getElementById('save-edit-btn').addEventListener('click', async () => {
            const val = document.getElementById('edit-text-input').value;
            const id = document.getElementById('edit-target-id').value;
            const col = document.getElementById('edit-target-collection').value; 
            const parentId = document.getElementById('edit-parent-id').value; 
            
            if(!val.trim()) return;

            try {
                // ১. যদি এটি পোস্ট হয়
                if(col === 'posts') {
                    await db.collection('posts').doc(id).update({
                        text: val,
                        isEdited: true
                    });
                    showToast('পোস্ট আপডেট হয়েছে!');
                    closeModal('edit-text-modal');
                    
                    // পেজ রিফ্রেশ না করে আপডেট দেখানোর জন্য
                    if(!document.getElementById('home-page').classList.contains('d-none')) loadNewsfeedPosts();
                    if(!document.getElementById('profile-page').classList.contains('d-none')) loadUserPosts(auth.currentUser.uid);
                }
                // ২. যদি এটি চ্যাট মেসেজ হয়
                else if(col === 'messages') {
                     await db.collection('chats').doc(parentId).collection('messages').doc(id).update({
                         text: val,
                         isEdited: true
                     });
                     showToast('মেসেজ এডিট হয়েছে');
                     closeModal('edit-text-modal');
                }
            } catch(e) { 
                console.error(e);
                showToast('সমস্যা হয়েছে: ' + e.message); 
            }
        });

        // Navigation Bindings
        document.getElementById('go-to-wallet').addEventListener('click', (e) => { e.preventDefault(); navigateTo('wallet-page'); loadWallet(); });
        document.getElementById('go-to-leaderboard').addEventListener('click', (e) => { e.preventDefault(); navigateTo('leaderboard-page'); loadLeaderboard(); });
        document.getElementById('go-to-subscription').addEventListener('click', (e) => { e.preventDefault(); navigateTo('subscription-page'); loadDepositHistory(); });
        document.getElementById('go-to-hidden').addEventListener('click', (e) => { e.preventDefault(); navigateTo('hidden-posts-page'); loadHiddenPosts(); });
        document.getElementById('go-to-withdraw').addEventListener('click', (e) => { e.preventDefault(); navigateTo('withdraw-page'); loadWithdrawHistory(); });

        document.getElementById('back-from-leaderboard').addEventListener('click', () => history.back());
        
       // UPDATED INBOX LOGIC (With Admin Fix)
document.getElementById('inbox-btn').addEventListener('click', async () => {
    navigateTo('inbox-page');
    const list = document.getElementById('inbox-list');
    list.innerHTML = '<div style="text-align:center; padding:20px;">লোড হচ্ছে...</div>';
    
    try {
        const snapshot = await db.collection('chats')
            .where('participants', 'array-contains', auth.currentUser.uid)
            .orderBy('lastUpdated', 'desc')
            .limit(20)
            .get();

        list.innerHTML = '';
        
        if(snapshot.empty) { 
            list.innerHTML = '<div style="text-align:center; padding:20px;">কোনো মেসেজ নেই।</div>'; 
            return; 
        }

        for (let doc of snapshot.docs) {
            const data = doc.data();
            const friendUid = data.participants.find(uid => uid !== auth.currentUser.uid);
            
            if(friendUid) {
                const userDoc = await db.collection('users').doc(friendUid).get();
                
                // --> পরিবর্তন শুরু এখান থেকে <--
                let u;
                
                if(userDoc.exists) {
                    // যদি সাধারণ ইউজার হয়
                    u = userDoc.data();
                } else {
                    // যদি ইউজার না পাওয়া যায় (মানে এটি অ্যাডমিন)
                    u = {
                        fullName: "Admin Team",
                        profilePicURL: "https://cdn-icons-png.flaticon.com/512/9703/9703596.png", // ডিফল্ট এডমিন আইকন
                        role: 'admin',
                        isVerified: true
                    };
                }
                // --> পরিবর্তন শেষ <--

                const badge = (u.role === 'admin') ? ' <span class="role-badge role-admin">Admin</span>' : '';
                
                const item = document.createElement('div'); 
                item.className = 'inbox-item';
                item.innerHTML = `
                    <img src="${u.profilePicURL || DEFAULT_PROFILE_PIC}" style="width:50px; height:50px; border-radius:50%; margin-right:15px; object-fit:cover;">
                    <div style="flex-grow:1;">
                        <h4 style="font-size:16px;">${u.fullName}${badge}</h4>
                        <p style="color:#777; font-size:12px;">মেসেজ দেখতে ট্যাপ করুন</p>
                    </div>
                `;
                
                // চ্যাট ওপেন করার সময় নাম ও ছবি পাঠানো হচ্ছে
                item.onclick = () => openChat(friendUid, u.fullName, u.profilePicURL, u.isVerified, null);
                list.appendChild(item);
            }
        }
    } catch (error) {
        console.error(error);
        if(error.message.includes('index')) {
             // মোবাইলে এলার্ট দিলে বুঝতে সুবিধা হবে
             alert("System Error: Index not found. Please create index in Firebase Console.");
        }
        list.innerHTML = '<div style="text-align:center; padding:20px; color:red;">লোড হতে সমস্যা হচ্ছে।</div>';
    }
});
        
        // Feature 2: Chat Image Logic
        document.getElementById('chat-img-btn').addEventListener('click', () => {
            document.getElementById('chat-img-input').click();
        });
        
        document.getElementById('chat-img-input').addEventListener('change', function(e) {
             if(this.files && this.files[0]) {
                 const reader = new FileReader();
                 reader.onload = function(evt) {
                     document.getElementById('chat-img-preview-elem').src = evt.target.result;
                     document.getElementById('chat-img-preview-container').style.display = 'block';
                 };
                 reader.readAsDataURL(this.files[0]);
             }
        });
        
        document.getElementById('remove-preview-btn').addEventListener('click', () => {
             document.getElementById('chat-img-input').value = '';
             document.getElementById('chat-img-preview-container').style.display = 'none';
        });

        function openChat(targetUid, name, pic, isVerified, badgeExpiry) {
            document.getElementById('chat-page').classList.remove('d-none');
            history.pushState({ page: 'chat-page' }, "", "#chat");
            
            // Feature 2: Show Blue Badge in Chat Header
            const badgeHtml = getVerificationHtml(isVerified, badgeExpiry);
            document.getElementById('chat-header-name').innerHTML = `${name} ${badgeHtml}`;
            document.getElementById('chat-header-pic').src = pic || DEFAULT_PROFILE_PIC;
            
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            const chatId = [auth.currentUser.uid, targetUid].sort().join('_');
            
            if(activeChatUnsubscribe) activeChatUnsubscribe();
            
            activeChatUnsubscribe = db.collection('chats').doc(chatId).collection('messages').orderBy('createdAt', 'asc').onSnapshot(snapshot => {
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderUid === auth.currentUser.uid;
                    const div = document.createElement('div'); 
                    div.className = `message-bubble ${isMe ? 'sent' : 'received'}`;
                    div.setAttribute('data-msg-id', doc.id);
                    
                    // Labels
                    let statusLabel = '';
                    if(msg.isDeleted) {
                        div.innerHTML = `<span style="color:#999; font-style:italic;">মেসেজটি ডিলিট করা হয়েছে</span>`;
                    } else {
                         if(msg.isEdited) statusLabel = '<span class="message-status">(Edited)</span>';
                         
                         // Context Menu
                         let menuHtml = '';
                         if(isMe) {
                             menuHtml = `
                             <button class="msg-options-btn"><i class="fas fa-chevron-down"></i></button>
                             <div class="msg-context-menu">
                                 <button onclick="triggerEditMsg('${doc.id}', '${chatId}', '${msg.text}')">Edit</button>
                                 <button onclick="triggerDeleteMsg('${doc.id}', '${chatId}')" style="color:red;">Delete</button>
                             </div>
                             `;
                         }
                         
                         div.innerHTML = `
                            ${msg.text} ${statusLabel}
                            ${msg.imageUrl ? `<br><img src="${msg.imageUrl}" class="message-img" onclick="window.open('${msg.imageUrl}')">` : ''}
                            <span class="message-time">${formatPostTime(msg.createdAt)}</span>
                            ${menuHtml}
                         `;
                    }
                    
                    container.appendChild(div);
                    
                    // Event listener for menu toggle
                    const menuBtn = div.querySelector('.msg-options-btn');
                    if(menuBtn) {
                        menuBtn.onclick = (e) => {
                            e.stopPropagation();
                            const menu = div.querySelector('.msg-context-menu');
                            document.querySelectorAll('.msg-context-menu').forEach(el => { if(el!==menu) el.style.display='none'; });
                            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                        }
                    }
                });
                container.scrollTop = container.scrollHeight;
            });
            
            document.getElementById('chat-form').onsubmit = async (e) => {
                e.preventDefault(); 
                const input = document.getElementById('chat-input'); 
                const text = input.value.trim();
                const imgInput = document.getElementById('chat-img-input');
                
                if(!text && !imgInput.files[0]) return;
                
                // Disable btn
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;
                
                let imgUrl = null;
                if(imgInput.files[0]) {
                    imgUrl = await uploadToCloudinary(imgInput.files[0]);
                }

                await db.collection('chats').doc(chatId).collection('messages').add({ 
                    text: text, 
                    imageUrl: imgUrl, 
                    senderUid: auth.currentUser.uid, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                // Feature 5: Ensure chat document exists for listing
                await db.collection('chats').doc(chatId).set({
                    participants: [auth.currentUser.uid, targetUid],
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                input.value = '';
                imgInput.value = '';
                document.getElementById('chat-img-preview-container').style.display = 'none';
                btn.disabled = false;
            };
        }
        
        window.triggerEditMsg = (id, chatId, oldText) => {
            document.getElementById('edit-target-id').value = id;
            document.getElementById('edit-parent-id').value = chatId;
            document.getElementById('edit-target-collection').value = 'messages';
            document.getElementById('edit-text-input').value = oldText;
            openModal('edit-text-modal');
        }
        
        window.triggerDeleteMsg = async (id, chatId) => {
            if(confirm("মেসেজটি ডিলিট করতে চান?")) {
                 await db.collection('chats').doc(chatId).collection('messages').doc(id).update({
                     isDeleted: true,
                     text: '',
                     imageUrl: null
                 });
            }
        }

        document.getElementById('back-from-chat').addEventListener('click', () => history.back());

        // SEARCH
        document.getElementById('search-btn').addEventListener('click', () => { document.getElementById('search-page').classList.remove('d-none'); document.getElementById('global-search-input').focus(); history.pushState({page: 'search-page'}, "", "#search"); });
        document.getElementById('close-search').addEventListener('click', () => history.back());
        
        document.getElementById('global-search-input').addEventListener('input', async (e) => {
            const val = e.target.value.trim();
            const resContainer = document.getElementById('search-results');
            resContainer.innerHTML = '';
            
            // Check if input is a Post ID (Assuming ID length > 15)
            if(val.length > 15) {
                try {
                    const postDoc = await db.collection('posts').doc(val).get();
                    if(postDoc.exists && postDoc.data().status === 'approved') {
                        const div = document.createElement('div');
                        div.style.padding = "10px";
                        div.innerHTML = "<strong>পোস্ট পাওয়া গেছে:</strong>";
                        resContainer.appendChild(div);
                        resContainer.appendChild(renderPost(postDoc));
                    }
                } catch(e) { console.log("Not a post ID"); }
            }

            if(val.length < 2) return;
            const snapshot = await db.collection('users').where('fullName', '>=', val).where('fullName', '<=', val + '\uf8ff').limit(5).get();
            if(!snapshot.empty) {
                snapshot.forEach(doc => {
                    const u = doc.data();
                    const badgeHtml = getVerificationHtml(u.isVerified, u.badgeExpiry);
                    const div = document.createElement('div'); div.className = 'search-result-item';
                    div.innerHTML = `<img src="${u.profilePicURL || DEFAULT_PROFILE_PIC}" class="search-user-pic"><span>${u.fullName} ${badgeHtml}</span>`;
                    div.onclick = () => loadUserProfile(u.uid);
                    resContainer.appendChild(div);
                });
            }
        });

        // Auth Navigation & Forms
        document.getElementById('go-to-login').addEventListener('click', (e) => { e.preventDefault(); navigateTo('login-page', false); });
        document.getElementById('go-to-signup').addEventListener('click', (e) => { e.preventDefault(); navigateTo('signup-page', false); });
        document.getElementById('header-logo-btn').addEventListener('click', () => navigateTo('home-page'));
        document.getElementById('nav-profile').addEventListener('click', (e) => { e.preventDefault(); loadUserProfile(auth.currentUser.uid); });
        document.getElementById('nav-settings').addEventListener('click', (e) => { e.preventDefault(); navigateTo('settings-page'); });
        document.getElementById('header-profile-pic').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('profile-dropdown').classList.toggle('show'); document.getElementById('notification-dropdown').classList.remove('show'); });
        document.getElementById('notif-btn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('notification-dropdown').classList.toggle('show'); document.getElementById('profile-dropdown').classList.remove('show'); });
        window.addEventListener('click', () => document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.remove('show')));
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            setBtnLoading('login-btn', true);
            try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); } 
            catch(err) { showToast(err.message); setBtnLoading('login-btn', false); }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            setBtnLoading('signup-btn', true);
            try {
                const fullname = document.getElementById('fullname').value;
                const dob = document.getElementById('dob').value;
                const gender = document.getElementById('gender').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                let picUrl = DEFAULT_PROFILE_PIC, coverUrl = '';
                if(document.getElementById('profile-pic-signup').files[0]) picUrl = await uploadToCloudinary(document.getElementById('profile-pic-signup').files[0]);
                if(document.getElementById('cover-photo-signup').files[0]) coverUrl = await uploadToCloudinary(document.getElementById('cover-photo-signup').files[0]);
                
                // Assign default role 'user'
                await db.collection('users').doc(cred.user.uid).set({
                    uid: cred.user.uid, fullName: fullname, email: email, dob: dob, gender: gender,
                    profilePicURL: picUrl, coverPhotoURL: coverUrl, followingCount: 0, followerCount: 0, totalLikes: 0, bio: '', walletBalance: 0.00, role: 'user', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('সাইন আপ সফল!');
            } catch(err) { showToast(err.message); setBtnLoading('signup-btn', false); }
        });

// --- NEW FUNCTION: Update User Data Globally (Posts & Comments) ---
async function updateUserProfileGlobally(updatedData) {
    const uid = auth.currentUser.uid;
    const batchLimit = 400; 
    let batch = db.batch();
    let operationCount = 0;

    console.log("Starting global update for:", updatedData);

    // ১. ইউজারের সব পোস্ট আপডেট করা
    const postsSnapshot = await db.collection('posts').where('authorUid', '==', uid).get();
    
    let postUpdateData = {};
    if (updatedData.fullName) postUpdateData.authorName = updatedData.fullName;
    if (updatedData.profilePicURL) postUpdateData.authorProfilePic = updatedData.profilePicURL;
    if (updatedData.role) postUpdateData.authorRole = updatedData.role;
    if (updatedData.hasOwnProperty('isVerified')) postUpdateData.isVerified = updatedData.isVerified;

    if (!postsSnapshot.empty) {
        for (const doc of postsSnapshot.docs) {
            batch.update(doc.ref, postUpdateData);
            operationCount++;

            if (operationCount >= batchLimit) {
                await batch.commit();
                batch = db.batch();
                operationCount = 0;
            }
        }
    }

    // ২. ইউজারের সব কমেন্ট আপডেট করা (Collection Group Query)
    try {
        // বি:দ্র: কনসোলে ইনডেক্স এরর আসলে লিংকে ক্লিক করে ইনডেক্স বানাতে হবে
        const commentsSnapshot = await db.collectionGroup('comments').where('authorUid', '==', uid).get();

        let commentUpdateData = {};
        if (updatedData.fullName) commentUpdateData.authorName = updatedData.fullName;
        if (updatedData.profilePicURL) commentUpdateData.authorProfilePic = updatedData.profilePicURL;
        if (updatedData.hasOwnProperty('isVerified')) commentUpdateData.isVerified = updatedData.isVerified;

        if (!commentsSnapshot.empty) {
            for (const doc of commentsSnapshot.docs) {
                batch.update(doc.ref, commentUpdateData);
                operationCount++;

                if (operationCount >= batchLimit) {
                    await batch.commit();
                    batch = db.batch();
                    operationCount = 0;
                }
            }
        }
    } catch (error) {
        console.error("Comments update error:", error);
        if(error.message.includes('requires an index')) {
            showToast("Admin: Please create 'comments' index in Firebase Console.");
        }
    }

    // বাকি থাকা ব্যাচ সেভ করা
    if (operationCount > 0) {
        await batch.commit();
    }
    
    console.log("Global update completed!");
}

      // --- REAL-TIME MAINTENANCE SYSTEM ---
        function initMaintenanceListener() {
            // system কালেকশনের maintenance ডকুমেন্টের দিকে লক্ষ্য রাখা
            db.collection('system').doc('maintenance').onSnapshot((doc) => {
                const overlay = document.getElementById('maintenance-overlay');
                const timeDisplay = document.getElementById('maintenance-time-display');
                const msgDisplay = document.getElementById('maintenance-message-text');

                if (doc.exists) {
                    const data = doc.data();
                    const isEnabled = data.enabled || false;
                    const message = data.message || "আমাদের অ্যাপের উন্নয়নের কাজ চলছে। দয়া করে কিছুক্ষণ পর আবার চেষ্টা করুন।";
                    
                    // সময় চেক করা (যদি এডমিন সময় সেট করে থাকে)
                    const now = new Date().getTime();
                    let isInTimeRange = true;

                    // যদি স্টার্ট এবং এন্ড টাইম দেওয়া থাকে
                    if (data.startTime && data.endTime) {
                        const start = new Date(data.startTime).getTime();
                        const end = new Date(data.endTime).getTime();
                        
                        // বর্তমান সময় যদি রেঞ্জের মধ্যে থাকে
                        if (now >= start && now <= end) {
                            isInTimeRange = true;
                            // সময় দেখানো (অপশনাল)
                            const endTimeStr = new Date(data.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            timeDisplay.textContent = `আনুমানিক খোলার সময়: ${endTimeStr}`;
                        } else {
                            isInTimeRange = false;
                        }
                    } else {
                        // সময় সেট না থাকলে এবং enabled true হলে সবসময় দেখাবে
                        timeDisplay.textContent = "";
                    }

                    // ফাইনাল লজিক: যদি enabled হয় এবং সময়ের মধ্যে থাকে
                    if (isEnabled && isInTimeRange) {
                        // শুধু এডমিন বাদে সবার জন্য ব্লক (অপশনাল, চাইলে এই if বাদ দিতে পারেন সব ব্লক করতে)
                        // বর্তমানে আমি চেক করছি না ইউজার এডমিন কিনা, যাতে আপনি টেস্ট করতে পারেন।
                        // রিয়েল টাইমে দেখানোর জন্য:
                        msgDisplay.textContent = message;
                        overlay.classList.add('active');
                        
                        // স্ক্রল বন্ধ করে দেওয়া
                        document.body.style.overflow = 'hidden';
                    } else {
                        // মেইনটেন্যান্স অফ
                        overlay.classList.remove('active');
                        document.body.style.overflow = 'auto';
                    }
                } else {
                    // ডকুমেন্ট না থাকলে অফ
                    overlay.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            }, (error) => {
                console.log("Maintenance sync error:", error);
            });
        }

        // অ্যাপ লোড হওয়ার সাথে সাথে লিসেনার চালু হবে
        initMaintenanceListener();

    </script>
   <script>
    // --- ADSTERRA AUTO LOADER ---
    document.addEventListener("DOMContentLoaded", async function() {
        try {
            // ১. ফায়ারবেস থেকে লিংক আনা
            const doc = await db.collection('system').doc('ads_config').get();
            if(doc.exists) {
                const data = doc.data();

                // ২. Popunder অ্যাড চালু থাকলে হেড-এ বসানো
                if(data.popStatus === 'on' && data.popLink) {
                    let s = document.createElement('script');
                    s.type = 'text/javascript';
                    s.src = data.popLink;
                    document.head.appendChild(s);
                    console.log("Popunder Active");
                }

                // ৩. Social Bar অ্যাড চালু থাকলে বডি-তে বসানো
                if(data.socialStatus === 'on' && data.socialLink) {
                    let s = document.createElement('script');
                    s.type = 'text/javascript';
                    s.src = data.socialLink;
                    document.body.appendChild(s);
                    console.log("Social Bar Active");
                }
            }
        } catch(e) {
            console.log("Ads Error: " + e.message);
        }
    });
</script>
</body>
</html>